<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circuit Simulator Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&amp;family=Roboto+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    :root {
      --red: #DC2626;
      --yellow: #F59E0B;
      --maroon: #7F1D1D;
      --gold: #D97706;
      --transparent-bg: rgba(127, 29, 29, 0.1);
    }
    
    * {
      font-family: 'Roboto Mono', monospace;
    }
    
    .title-font {
      font-family: 'Orbitron', sans-serif;
    }
    
    .circuit-canvas {
      background: 
        linear-gradient(rgba(217, 119, 6, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(217, 119, 6, 0.1) 1px, transparent 1px),
        linear-gradient(135deg, #1a0a0a 0%, #2d1010 50%, #1a0a0a 100%);
      background-size: 20px 20px, 20px 20px, 100% 100%;
    }
    
    .component {
      cursor: grab;
      transition: all 0.2s ease;
    }
    
    .component:hover {
      transform: scale(1.05);
      filter: brightness(1.2);
    }
    
    .component.dragging {
      cursor: grabbing;
      opacity: 0.8;
      z-index: 1000;
    }
    
    .wire {
      stroke: #D97706;
      stroke-width: 3;
      fill: none;
      filter: drop-shadow(0 0 3px rgba(217, 119, 6, 0.5));
    }
    
    .wire.powered {
      animation: wirePulse 1s infinite;
    }
    
    @keyframes wirePulse {
      0%, 100% { stroke: #D97706; filter: drop-shadow(0 0 3px rgba(217, 119, 6, 0.5)); }
      50% { stroke: #F59E0B; filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.8)); }
    }
    
    .electron {
      fill: #F59E0B;
      filter: drop-shadow(0 0 4px #F59E0B);
    }
    
    @keyframes electronMove {
      0% { offset-distance: 0%; }
      100% { offset-distance: 100%; }
    }
    
    .glow-red {
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
    }
    
    .glow-gold {
      box-shadow: 0 0 15px rgba(217, 119, 6, 0.5);
    }
    
    .panel {
      background: linear-gradient(145deg, rgba(127, 29, 29, 0.95), rgba(26, 10, 10, 0.98));
      border: 2px solid #D97706;
      backdrop-filter: blur(10px);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #DC2626, #7F1D1D);
      border: 2px solid #D97706;
      color: #F59E0B;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background: linear-gradient(145deg, #EF4444, #991B1B);
      box-shadow: 0 0 20px rgba(217, 119, 6, 0.5);
    }
    
    .btn-secondary {
      background: linear-gradient(145deg, #7F1D1D, #450a0a);
      border: 2px solid #D97706;
      color: #F59E0B;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(145deg, #991B1B, #7F1D1D);
    }
    
    .component-btn {
      background: linear-gradient(145deg, rgba(127, 29, 29, 0.8), rgba(26, 10, 10, 0.9));
      border: 2px solid #D97706;
      color: #F59E0B;
      transition: all 0.3s ease;
    }
    
    .component-btn:hover {
      background: linear-gradient(145deg, #DC2626, #7F1D1D);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(217, 119, 6, 0.3);
    }
    
    .solution-panel {
      background: linear-gradient(145deg, rgba(217, 119, 6, 0.1), rgba(127, 29, 29, 0.2));
      border: 2px solid #D97706;
      border-radius: 12px;
    }
    
    .example-card {
      background: linear-gradient(145deg, rgba(127, 29, 29, 0.6), rgba(26, 10, 10, 0.8));
      border: 2px solid #D97706;
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .example-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(217, 119, 6, 0.3);
    }
    
    .tab-active {
      background: linear-gradient(145deg, #DC2626, #7F1D1D);
      border-bottom: 3px solid #F59E0B;
    }
    
    .editable-value {
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(217, 119, 6, 0.2);
      border: 1px dashed #D97706;
      transition: all 0.2s ease;
    }
    
    .editable-value:hover {
      background: rgba(217, 119, 6, 0.4);
      border-style: solid;
    }
    
    .scroll-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scroll-thin::-webkit-scrollbar-track {
      background: rgba(127, 29, 29, 0.3);
    }
    
    .scroll-thin::-webkit-scrollbar-thumb {
      background: #D97706;
      border-radius: 3px;
    }
    
    .bulb-glow {
      animation: bulbPulse 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes bulbPulse {
      0% { filter: drop-shadow(0 0 5px #F59E0B); }
      100% { filter: drop-shadow(0 0 15px #F59E0B) brightness(1.3); }
    }
    
    .exploded {
      animation: explode 0.5s ease-out forwards;
    }
    
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(0.5); opacity: 0.3; filter: grayscale(1); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <style>
    /* Component palette layout tweaks */
    #components-panel {
      display: grid;

      /* This is the magic line - auto-fill to avoid empty gaps */
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));

      gap: 14px;

      padding: 14px;

      width: 100%;
      box-sizing: border-box;

      max-height: 75vh;
      overflow-y: auto;
    }

    /* Ensure buttons fill their grid cell and have consistent height */
    .component-btn {
      width: 100%;
      height: 90px;

      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

      box-sizing: border-box;
    }

    /* Clean scrollbar for WebKit browsers */
    #components-panel::-webkit-scrollbar { width: 6px; }
    #components-panel::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 6px; }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-gray-900 via-red-950 to-gray-900 text-yellow-400 overflow-auto">
  <div id="app-container" class="min-h-full w-full p-4"><!-- Header -->
   <header class="text-center mb-4">
    <h1 id="app-title" class="title-font text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-yellow-500 to-red-500 mb-2">‚ö° Circuit Simulator Lab ‚ö°</h1>
    <p class="text-gold text-sm opacity-80">Build ‚Ä¢ Analyze     Learn</p>
   </header><!-- Main Tabs -->
   <div class="flex justify-center gap-2 mb-4 flex-wrap"><button onclick="switchTab('builder')" id="tab-builder" class="tab-active px-4 py-2 rounded-t-lg component-btn text-sm font-bold"> üîß Circuit Builder </button> <button onclick="switchTab('examples')" id="tab-examples" class="px-4 py-2 rounded-t-lg component-btn text-sm font-bold"> üìö Example Circuits </button>
   </div><!-- Builder Tab -->
   <div id="builder-tab" class="grid grid-cols-1 lg:grid-cols-4 gap-4"><!-- Component Palette -->
    <div class="lg:col-span-1 panel rounded-xl p-2" style="overflow:hidden;">
     <h2 class="title-font text-lg font-bold text-yellow-400 mb-3 flex items-center gap-2"><span class="text-2xl">üß∞</span> Components</h2>
     <div id="components-panel"
     class="grid grid-cols-2 auto-rows-fr gap-3 w-full mb-4 scroll-thin overflow-y-auto"
     style="max-height:75vh;">
</div>
    <div class="border-t border-gold/30 pt-3 mb-3"><button onclick="toggleViewMode()" id="view-mode-btn" class="w-full btn-secondary py-2 px-4 rounded-lg text-sm font-bold mb-2"> üé® View: Realistic </button> <button onclick="toggleSchematicMode()" id="schematic-mode-btn" class="w-full btn-secondary py-2 px-4 rounded-lg text-sm font-bold mb-2"> üìê Schematic Mode: OFF </button> <button onclick="autoAlignParallel()" id="auto-clean-btn" class="w-full btn-secondary py-2 px-4 rounded-lg text-sm font-bold mb-2"> ‚ú® Auto Clean Layout </button> <button onclick="toggleWireMode()" id="wire-mode-btn" class="w-full btn-secondary py-2 px-4 rounded-lg text-sm font-bold mb-2">    Wire Mode: OFF </button> <button onclick="centerView()" class="w-full btn-secondary py-2 px-4 rounded-lg text-sm font-bold mb-2"> üéØ Center View </button> <button onclick="clearCanvas()" class="w-full btn-primary py-2 px-4 rounded-lg text-sm font-bold">    Ô∏è Clear All </button>
     </div>
     <div class="text-xs text-yellow-400/60 space-y-1">
      <p>üí° Click values to edit</p>
      <p>üîå Connect with wire mode</p>
      <p>üñ±Ô∏è Drag to move</p>
     </div>
    </div><!-- Canvas Area -->
    <div class="lg:col-span-2 panel rounded-xl p-4">
     <div class="flex justify-between items-center mb-3">
      <h2 class="title-font text-lg font-bold text-yellow-400 flex items-center gap-2"><span class="text-2xl">‚ö°</span> Circuit Canvas</h2><button onclick="testCircuit()" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"> ‚ñ∂Ô∏è Test Circuit </button>
     </div>
     <div id="canvas-container" class="circuit-canvas rounded-xl relative overflow-hidden" style="height: 600px;">
      <svg id="circuit-svg" class="w-full h-full absolute top-0 left-0" style="z-index: 1;"><defs>
        <marker id="electron-marker" markerwidth="6" markerheight="6" refx="3" refy="3">
         <circle cx="3" cy="3" r="2" class="electron" />
        </marker>
       </defs> <g id="wires-layer"></g> <g id="electrons-layer"></g>
      </svg>
      <div id="components-layer" class="absolute top-0 left-0 w-full h-full" style="z-index: 2;"></div>
     </div>
    </div><!-- Analysis Panel -->
    <div class="lg:col-span-1 panel rounded-xl p-4 scroll-thin overflow-y-auto" style="max-height: 500px;">
     <div class="flex justify-between items-center mb-3">
      <h2 class="title-font text-lg font-bold text-yellow-400 flex items-center gap-2"><span class="text-2xl">üìä</span> Analysis</h2><button onclick="toggleSolution()" id="solution-toggle" class="btn-secondary px-3 py-1 rounded-lg text-xs font-bold"> üëÅÔ∏è Show Solution </button>
     </div><!-- Circuit Status -->
     <div id="circuit-status" class="solution-panel p-3 mb-3">
      <div class="text-center text-yellow-400/60">
       Build a circuit to see analysis
      </div>
     </div><!-- Solution Panel (Hidden by default) -->
     <div id="solution-panel" class="hidden">
      <div class="solution-panel p-3 mb-3">
       <h3 class="font-bold text-yellow-400 mb-2 flex items-center gap-2">üßÆ Computation Steps</h3>
       <div id="computation-steps" class="text-xs space-y-2 text-yellow-400/80"><!-- Steps will be inserted here -->
       </div>
      </div>
      <div class="solution-panel p-3">
       <h3 class="font-bold text-yellow-400 mb-2 flex items-center gap-2">üìê Formulas Used</h3>
       <div id="formulas-used" class="text-xs space-y-1 text-yellow-400/80"><!-- Formulas will be inserted here -->
       </div>
      </div>
     </div><!-- Quick Stats -->
     <div class="solution-panel p-3 mt-3">
      <h3 class="font-bold text-yellow-400 mb-2">üì¶ Components</h3>
      <div id="component-stats" class="text-xs space-y-1 text-yellow-400/80">
       <div>
        üîã Batteries: <span id="stat-batteries">0</span>
       </div>
       <div>
             Resistors: <span id="stat-resistors">0</span>
       </div>
       <div>
             Bulbs/LEDs: <span id="stat-bulbs">0</span>
       </div>
       <div>
        üîå Wires: <span id="stat-wires">0</span>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Examples Tab -->
   <div id="examples-tab" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 auto-rows-fr gap-6"><!-- Series Circuit Example -->
     <div class="example-card p-5">
      <div class="flex justify-between items-start mb-4">
       <div>
        <h3 class="title-font text-xl font-bold text-yellow-400 mb-1">üîó Series Circuit</h3>
        <p class="text-xs text-yellow-400/60">Components connected end-to-end</p>
       </div><button onclick="loadExample('series')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"> Load Example </button>
      </div><!-- Series Circuit Diagram -->
      <div class="circuit-canvas rounded-lg p-4 mb-4" style="height: 150px;">
       <svg viewbox="0 0 400 120" class="w-full h-full"><!-- Battery --> <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2" /> <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4" /> <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2" /> <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         12V
        </text> <!-- Wire from battery --> <line x1="60" y1="60" x2="100" y2="60" stroke="#D97706" stroke-width="3" /> <!-- Resistor 1 --> <path d="M100,60 L110,60 L115,50 L125,70 L135,50 L145,70 L150,60 L160,60" fill="none" stroke="#D97706" stroke-width="2" /> <text x="130" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         R1=10Œ©
        </text> <!-- Wire --> <line x1="160" y1="60" x2="200" y2="60" stroke="#D97706" stroke-width="3" /> <!-- Resistor 2 --> <path d="M200,60 L210,60 L215,50 L225,70 L235,50 L245,70 L250,60 L260,60" fill="none" stroke="#D97706" stroke-width="2" /> <text x="230" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         R2=20Œ©
        </text> <!-- Wire --> <line x1="260" y1="60" x2="300" y2="60" stroke="#D97706" stroke-width="3" /> <!-- Bulb --> <circle cx="320" cy="60" r="15" fill="none" stroke="#D97706" stroke-width="2" /> <path d="M310,60 L330,60 M320,50 L320,70" stroke="#F59E0B" stroke-width="1" /> <text x="320" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         R3=10Œ©
        </text> <!-- Return wire --> <line x1="335" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" />
       </svg>
      </div><!-- Solution Section -->
      <div class="solution-panel p-3">
       <div class="flex justify-between items-center mb-2">
        <h4 class="font-bold text-yellow-400 text-sm">   Solution</h4><button onclick="toggleExampleSolution('series')" id="series-solution-btn" class="btn-secondary px-2 py-1 rounded text-xs"> üëÅÔ∏è Show </button>
       </div>
       <div id="series-solution" class="hidden text-xs text-yellow-400/80 space-y-2">
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Given:</strong>
         <p>‚Ä¢ Voltage (V) = 12V</p>
         <p>‚Ä¢ R1 = 10Œ©, R2 = 20Œ©, R3 = 10Œ©</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 1: Total Resistance</strong>
         <p>R_total = R1 + R2 + R3 (Series)</p>
         <p>R_total = 10 + 20 + 10 = <span class="text-green-400 font-bold">40Œ©</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 2: Current (Ohm's Law)</strong>
         <p>I = V / R_total</p>
         <p>I = 12 / 40 = <span class="text-green-400 font-bold">0.3A</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 3: Voltage Drops</strong>
         <p>V1 = I √ó R1 = 0.3 √ó 10 = <span class="text-green-400 font-bold">3V</span></p>
         <p>V2 = I √ó R2 = 0.3 √ó 20 = <span class="text-green-400 font-bold">6V</span></p>
         <p>V3 = I √ó R3 = 0.3 √ó 10 = <span class="text-green-400 font-bold">3V</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 4: Power</strong>
         <p>P = V √ó I = 12    0.3 = <span class="text-green-400 font-bold">3.6W</span></p>
        </div>
        <div class="bg-green-900/40 p-2 rounded border border-green-500/50"><strong class="text-green-400">   Key Points:</strong>
         <p>‚Ä¢ Same current flows through all components</p>
         <p>‚Ä¢ Voltage divides across components</p>
         <p>‚Ä¢ Total voltage = Sum of voltage drops</p>
        </div>
       </div>
      </div>
     </div><!-- Parallel Circuit Example -->
     <div class="example-card p-5">
      <div class="flex justify-between items-start mb-4">
       <div>
        <h3 class="title-font text-xl font-bold text-yellow-400 mb-1">‚ö° Parallel Circuit</h3>
        <p class="text-xs text-yellow-400/60">Components connected across same points</p>
       </div><button onclick="loadExample('parallel')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"> Load Example </button>
      </div><!-- Parallel Circuit Diagram -->
      <div class="circuit-canvas rounded-lg p-4 mb-4" style="height: 150px;">
       <svg viewbox="0 0 400 120" class="w-full h-full"><!-- Battery --> <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2" /> <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4" /> <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2" /> <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         12V
        </text> <!-- Main wire to junction --> <line x1="60" y1="60" x2="120" y2="60" stroke="#D97706" stroke-width="3" /> <!-- Junction point top --> <circle cx="120" cy="60" r="4" fill="#F59E0B" /> <!-- Top branch --> <line x1="120" y1="60" x2="120" y2="30" stroke="#D97706" stroke-width="3" /> <line x1="120" y1="30" x2="180" y2="30" stroke="#D97706" stroke-width="3" /> <path d="M180,30 L190,30 L195,20 L205,40 L215,20 L225,40 L230,30 L240,30" fill="none" stroke="#D97706" stroke-width="2" /> <text x="210" y="15" fill="#F59E0B" font-size="10" text-anchor="middle">
         R1=20Œ©
        </text> <line x1="240" y1="30" x2="300" y2="30" stroke="#D97706" stroke-width="3" /> <!-- Bottom branch --> <line x1="120" y1="60" x2="120" y2="90" stroke="#D97706" stroke-width="3" /> <line x1="120" y1="90" x2="180" y2="90" stroke="#D97706" stroke-width="3" /> <path d="M180,90 L190,90 L195,80 L205,100 L215,80 L225,100 L230,90 L240,90" fill="none" stroke="#D97706" stroke-width="2" /> <text x="210" y="115" fill="#F59E0B" font-size="10" text-anchor="middle">
         R2=30Œ©
        </text> <line x1="240" y1="90" x2="300" y2="90" stroke="#D97706" stroke-width="3" /> <!-- Junction point right --> <circle cx="300" cy="60" r="4" fill="#F59E0B" /> <line x1="300" y1="30" x2="300" y2="90" stroke="#D97706" stroke-width="3" /> <!-- Return wire --> <line x1="300" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" />
       </svg>
      </div><!-- Solution Section -->
      <div class="solution-panel p-3">
       <div class="flex justify-between items-center mb-2">
        <h4 class="font-bold text-yellow-400 text-sm">üìù Solution</h4><button onclick="toggleExampleSolution('parallel')" id="parallel-solution-btn" class="btn-secondary px-2 py-1 rounded text-xs"> üëÅÔ∏è Show </button>
       </div>
       <div id="parallel-solution" class="hidden text-xs text-yellow-400/80 space-y-2">
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Given:</strong>
         <p>‚Ä¢ Voltage (V) = 12V</p>
         <p>‚Ä¢ R1 = 20Œ©, R2 = 30Œ©</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 1: Total Resistance</strong>
         <p>1/R_total = 1/R1 + 1/R2 (Parallel)</p>
         <p>1/R_total = 1/20 + 1/30</p>
         <p>1/R_total = 0.05 + 0.0333 = 0.0833</p>
         <p>R_total = 1/0.0833 = <span class="text-green-400 font-bold">12Œ©</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 2: Total Current</strong>
         <p>I_total = V / R_total</p>
         <p>I_total = 12 / 12 = <span class="text-green-400 font-bold">1A</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 3: Branch Currents</strong>
         <p>I1 = V / R1 = 12 / 20 = <span class="text-green-400 font-bold">0.6A</span></p>
         <p>I2 = V / R2 = 12 / 30 = <span class="text-green-400 font-bold">0.4A</span></p>
         <p class="text-yellow-400/60">Verify: I1 + I2 = 0.6 + 0.4 = 1A ‚úì</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 4: Power</strong>
         <p>P_total = V √ó I_total = 12 √ó 1 = <span class="text-green-400 font-bold">12W</span></p>
         <p>P1 = V¬≤/R1 = 144/20 = 7.2W</p>
         <p>P2 = V¬≤/R2 = 144/30 = 4.8W</p>
        </div>
        <div class="bg-green-900/40 p-2 rounded border border-green-500/50"><strong class="text-green-400">‚úÖ Key Points:</strong>
         <p>‚Ä¢ Same voltage across all branches</p>
         <p>‚Ä¢ Current divides among branches</p>
         <p>‚Ä¢ Total current = Sum of branch currents</p>
         <p>‚Ä¢ Total resistance &lt; smallest branch resistance</p>
        </div>
       </div>
      </div>
     </div><!-- Mixed Circuit Example -->
     <div class="example-card p-5">
      <div class="flex justify-between items-start mb-4">
       <div>
        <h3 class="title-font text-xl font-bold text-yellow-400 mb-1">     Mixed Circuit</h3>
        <p class="text-xs text-yellow-400/60">Series + Parallel combination</p>
       </div><button onclick="loadExample('mixed')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"> Load Example </button>
      </div><!-- Mixed Circuit Diagram -->
      <div class="circuit-canvas rounded-lg p-4 mb-4" style="height: 150px;">
       <svg viewbox="0 0 400 120" class="w-full h-full"><!-- Battery --> <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2" /> <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4" /> <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2" /> <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">
         24V
        </text> <!-- Series resistor --> <line x1="60" y1="60" x2="80" y2="60" stroke="#D97706" stroke-width="3" /> <path d="M80,60 L90,60 L95,50 L105,70 L115,50 L125,70 L130,60 L140,60" fill="none" stroke="#D97706" stroke-width="2" /> <text x="110" y="40" fill="#F59E0B" font-size="10" text-anchor="middle">
         R1=8Œ©
        </text> <!-- Junction to parallel --> <line x1="140" y1="60" x2="160" y2="60" stroke="#D97706" stroke-width="3" /> <circle cx="160" cy="60" r="4" fill="#F59E0B" /> <!-- Parallel section --> <line x1="160" y1="60" x2="160" y2="30" stroke="#D97706" stroke-width="3" /> <line x1="160" y1="30" x2="200" y2="30" stroke="#D97706" stroke-width="3" /> <path d="M200,30 L205,30 L208,22 L214,38 L220,22 L226,38 L230,30 L235,30" fill="none" stroke="#D97706" stroke-width="2" /> <text x="218" y="18" fill="#F59E0B" font-size="8" text-anchor="middle">
         R2=12Œ©
        </text> <line x1="235" y1="30" x2="280" y2="30" stroke="#D97706" stroke-width="3" /> <line x1="160" y1="60" x2="160" y2="90" stroke="#D97706" stroke-width="3" /> <line x1="160" y1="90" x2="200" y2="90" stroke="#D97706" stroke-width="3" /> <path d="M200,90 L205,90 L208,82 L214,98 L220,82 L226,98 L230,90 L235,90" fill="none" stroke="#D97706" stroke-width="2" /> <text x="218" y="110" fill="#F59E0B" font-size="8" text-anchor="middle">
         R3=12Œ©
        </text> <line x1="235" y1="90" x2="280" y2="90" stroke="#D97706" stroke-width="3" /> <circle cx="280" cy="60" r="4" fill="#F59E0B" /> <line x1="280" y1="30" x2="280" y2="90" stroke="#D97706" stroke-width="3" /> <!-- Bulb after parallel --> <line x1="280" y1="60" x2="310" y2="60" stroke="#D97706" stroke-width="3" /> <circle cx="330" cy="60" r="12" fill="none" stroke="#D97706" stroke-width="2" /> <path d="M322,60 L338,60 M330,52 L330,68" stroke="#F59E0B" stroke-width="1" /> <text x="330" y="85" fill="#F59E0B" font-size="8" text-anchor="middle">
         R4=10Œ©
        </text> <!-- Return --> <line x1="342" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" /> <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" />
       </svg>
      </div><!-- Solution Section -->
      <div class="solution-panel p-3">
       <div class="flex justify-between items-center mb-2">
        <h4 class="font-bold text-yellow-400 text-sm">    Solution</h4><button onclick="toggleExampleSolution('mixed')" id="mixed-solution-btn" class="btn-secondary px-2 py-1 rounded text-xs"> üëÅÔ∏è Show </button>
       </div>
       <div id="mixed-solution" class="hidden text-xs text-yellow-400/80 space-y-2">
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Given:</strong>
         <p>‚Ä¢ V = 24V, R1 = 8Œ© (series)</p>
         <p>‚Ä¢ R2 = R3 = 12Œ© (parallel)</p>
         <p>‚Ä¢ R4 = 10Œ© (series with parallel combo)</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 1: Parallel Combo</strong>
         <p>1/R_p = 1/12 + 1/12 = 2/12 = 1/6</p>
         <p>R_parallel = <span class="text-green-400 font-bold">6Œ©</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 2: Total Resistance</strong>
         <p>R_total = R1 + R_parallel + R4</p>
         <p>R_total = 8 + 6 + 10 = <span class="text-green-400 font-bold">24Œ©</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 3: Total Current</strong>
         <p>I = V / R_total = 24 / 24 = <span class="text-green-400 font-bold">1A</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 4: Voltage Drops</strong>
         <p>V_R1 = 1 √ó 8 = <span class="text-green-400 font-bold">8V</span></p>
         <p>V_parallel = 1 √ó 6 = <span class="text-green-400 font-bold">6V</span></p>
         <p>V_R4 = 1 √ó 10 = <span class="text-green-400 font-bold">10V</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Step 5: Branch Currents</strong>
         <p>I_R2 = 6/12 = <span class="text-green-400 font-bold">0.5A</span></p>
         <p>I_R3 = 6/12 = <span class="text-green-400 font-bold">0.5A</span></p>
        </div>
        <div class="bg-green-900/40 p-2 rounded border border-green-500/50"><strong class="text-green-400">‚úÖ Verification:</strong>
         <p>V_R1 + V_p + V_R4 = 8 + 6 + 10 = 24V ‚úì</p>
         <p>I_R2 + I_R3 = 0.5 + 0.5 = 1A ‚úì</p>
        </div>
       </div>
      </div>
     </div><!-- Voltage Divider Example -->
     <div class="example-card p-5">
      <div class="flex justify-between items-start mb-4">
       <div>
        <h3 class="title-font text-xl font-bold text-yellow-400 mb-1">üìè Voltage Divider</h3>
        <p class="text-xs text-yellow-400/60">Splitting voltage using resistors</p>
       </div><button onclick="loadExample('divider')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"> Load Example </button>
      </div><!-- Voltage Divider Diagram -->
      <div class="circuit-canvas rounded-lg p-4 mb-4" style="height: 150px;">
       <svg viewbox="0 0 400 120" class="w-full h-full"><!-- Battery --> <rect x="50" y="20" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2" /> <line x1="60" y1="25" x2="60" y2="45" stroke="#F59E0B" stroke-width="4" /> <line x1="80" y1="30" x2="80" y2="40" stroke="#F59E0B" stroke-width="2" /> <text x="70" y="15" fill="#F59E0B" font-size="10" text-anchor="middle">
         9V
        </text> <!-- Top wire --> <line x1="90" y1="35" x2="200" y2="35" stroke="#D97706" stroke-width="3" /> <!-- R1 vertical --> <path d="M200,35 L200,45 L190,50 L210,60 L190,70 L210,80 L200,85 L200,95" fill="none" stroke="#D97706" stroke-width="2" /> <text x="230" y="65" fill="#F59E0B" font-size="10" text-anchor="start">
         R1=3kŒ©
        </text> <!-- Vout point --> <circle cx="200" cy="95" r="4" fill="#F59E0B" /> <line x1="200" y1="95" x2="280" y2="95" stroke="#D97706" stroke-width="3" stroke-dasharray="5,3" /> <text x="300" y="98" fill="#DC2626" font-size="12" text-anchor="start">
         Vout
        </text> <!-- R2 vertical --> <path d="M200,95 L200,100 L190,105 L210,115 L190,125 L210,135 L200,140 L200,145" fill="none" stroke="#D97706" stroke-width="2" /> <text x="230" y="125" fill="#F59E0B" font-size="10" text-anchor="start">
         R2=1kŒ©
        </text> <!-- Ground symbol --> <line x1="200" y1="145" x2="200" y2="155" stroke="#D97706" stroke-width="3" /> <line x1="185" y1="155" x2="215" y2="155" stroke="#D97706" stroke-width="3" /> <line x1="190" y1="160" x2="210" y2="160" stroke="#D97706" stroke-width="2" /> <line x1="195" y1="165" x2="205" y2="165" stroke="#D97706" stroke-width="1" /> <!-- Return to battery --> <line x1="50" y1="50" x2="50" y2="155" stroke="#D97706" stroke-width="3" /> <line x1="50" y1="155" x2="185" y2="155" stroke="#D97706" stroke-width="3" />
       </svg>
      </div><!-- Solution Section -->
      <div class="solution-panel p-3">
       <div class="flex justify-between items-center mb-2">
        <h4 class="font-bold text-yellow-400 text-sm">üìù Solution</h4><button onclick="toggleExampleSolution('divider')" id="divider-solution-btn" class="btn-secondary px-2 py-1 rounded text-xs"> üëÅÔ∏è Show </button>
       </div>
       <div id="divider-solution" class="hidden text-xs text-yellow-400/80 space-y-2">
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Given:</strong>
         <p>‚Ä¢ Vin = 9V</p>
         <p>‚Ä¢ R1 = 3kŒ©, R2 = 1kŒ©</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Voltage Divider Formula:</strong>
         <p class="font-mono bg-black/30 p-1 rounded mt-1">Vout = Vin √ó (R2 / (R1 + R2))</p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Calculation:</strong>
         <p>Vout = 9 √ó (1000 / (3000 + 1000))</p>
         <p>Vout = 9 √ó (1000 / 4000)</p>
         <p>Vout = 9 √ó 0.25 = <span class="text-green-400 font-bold">2.25V</span></p>
        </div>
        <div class="bg-maroon/30 p-2 rounded"><strong class="text-yellow-400">Current Through Circuit:</strong>
         <p>I = Vin / (R1 + R2)</p>
         <p>I = 9 / 4000 = <span class="text-green-400 font-bold">2.25mA</span></p>
        </div>
        <div class="bg-green-900/40 p-2 rounded border border-green-500/50"><strong class="text-green-400">‚úÖ Applications:</strong>
         <p>    Sensor signal conditioning</p>
         <p>    Reference voltage generation</p>
         <p>‚Ä¢ Biasing transistors</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: 'Circuit Simulator Lab',
      background_color: '#1a0a0a',
      surface_color: '#7F1D1D',
      text_color: '#F59E0B',
      primary_action_color: '#DC2626',
      secondary_action_color: '#D97706'
    };
    
    let config = { ...defaultConfig };
    
    // Circuit state
    let components = [];
    let wires = [];
    let componentIdCounter = 0;
    let wireMode = false;
    let wireStart = null;
    let draggedComponent = null;
    let dragOffset = { x: 0, y: 0 };
    let solutionVisible = false;
    let circuitPowered = false;
    let electronAnimations = [];
    // Electron animation state for requestAnimationFrame-driven animation
    let electronAnimState = { rafId: null, electrons: [], lastTime: 0 };
    let schematicMode = false;
    let currentSchematic = null;
    let viewMode = 'realistic'; // 'realistic' or 'schematic'
    
    // Component types with properties
    const componentTypes = {
      battery: { symbol: 'battery', name: 'Battery', voltage: 12, hasValue: true, valueType: 'voltage' },
      resistor: { symbol: 'resistor', name: 'Resistor', resistance: 100, hasValue: true, valueType: 'resistance' },
      bulb: { symbol: 'bulb', name: 'Bulb', resistance: 50, maxVoltage: 15, hasValue: true, valueType: 'resistance' },
      switch: { symbol: 'switch', name: 'Switch', closed: true, hasValue: false },
      led: { symbol: 'led', name: 'LED', forwardVoltage: 2, resistance: 20, hasValue: true, valueType: 'resistance' },
      capacitor: { symbol: 'capacitor', name: 'Capacitor', capacitance: 100, hasValue: true, valueType: 'capacitance' },

      // New resistive/advanced components (include resistance so solver integrates them)
      thermistor: { symbol: 'thermistor', name: 'Thermistor', resistance: 1000 },
      ldr: { symbol: 'ldr', name: 'LDR', resistance: 500 },
      varistor: { symbol: 'varistor', name: 'Varistor', resistance: 200 },
      fuse: { symbol: 'fuse', name: 'Fuse', resistance: 1, maxCurrent: 2 },
      motor: { symbol: 'motor', name: 'Motor', resistance: 50 },
      speaker: { symbol: 'speaker', name: 'Speaker', resistance: 8 },
      heater: { symbol: 'heater', name: 'Heater', resistance: 20 },
      fan: { symbol: 'fan', name: 'Fan', resistance: 40 },
      relay: { symbol: 'relay', name: 'Relay', resistance: 60 },
      inductor: { symbol: 'inductor', name: 'Inductor', resistance: 5 },
      zener: { symbol: 'zener', name: 'Zener', resistance: 15 },
      diode: { symbol: 'diode', name: 'Diode', resistance: 10 },
      potentiometer: { symbol: 'potentiometer', name: 'Potentiometer', resistance: 1000 },
      transistor: { symbol: 'transistor', name: 'Transistor', resistance: 100 },
      opamp: { symbol: 'opamp', name: 'OpAmp', resistance: 1000 },
      ic: { symbol: 'ic', name: 'IC', resistance: 500 },
      photodiode: { symbol: 'photodiode', name: 'Photodiode', resistance: 300 },
      buzzer: { symbol: 'buzzer', name: 'Buzzer', resistance: 30 },
      ammeter: { symbol: 'ammeter', name: 'Ammeter', resistance: 0.001 },
      voltmeter: { symbol: 'voltmeter', name: 'Voltmeter', resistance: 1000000 }
    };
    

    // Palette renderer - dynamically builds component buttons from componentTypes
    function renderComponentPalette() {
      const panel = document.getElementById('components-panel');
      if (!panel) return;

      panel.innerHTML = '';

      panel.style.maxHeight = '75vh';
      panel.style.overflowY = 'auto';
      panel.style.display = 'grid';
      panel.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';
      panel.style.gap = '10px';
      panel.style.paddingRight = '6px';

      const icons = {
        battery: 'üîã',
        resistor: '‚ö°',
        bulb: 'üí°',
        switch: '‚èª',
        led: 'üî¥',
        capacitor: '‚ïë‚ïë',
        thermistor: 'üå°Ô∏è',
        ldr: '‚òÄÔ∏è',
        varistor: 'üü†',
        fuse: 'üî•',
        motor: '‚öôÔ∏è',
        speaker: 'üîä',
        heater: '‚ô®Ô∏è',
        fan: 'üåÄ',
        relay: 'üîÅ',
        inductor: 'üß≤',
        zener: 'üîª',
        diode: '‚ñ∂|',
        potentiometer: 'üéöÔ∏è',
        transistor: 'üî∫',
        opamp: '‚ûï',
        ic: 'üíæ',
        photodiode: 'üì∏',
        buzzer: 'üîî',
        ammeter: 'üìä',
        voltmeter: 'üìü'
      };

      Object.keys(componentTypes).forEach(type => {

        const btn = document.createElement('button');
        btn.className = "component-btn p-3 rounded-lg text-center";
        btn.onclick = () => addComponent(type);

        btn.style.width = '100%';
        btn.style.height = '100%';
        btn.style.boxSizing = 'border-box';
        btn.style.background = 'linear-gradient(145deg,#7f1d1d,#450a0a)';
        btn.style.border = '2px solid #f59e0b';
        btn.style.borderRadius = '8px';
        btn.style.padding = '6px';
        btn.style.fontSize = '12px';
        btn.style.color = '#facc15';
        btn.style.cursor = 'pointer';
        btn.style.display = 'flex';
        btn.style.flexDirection = 'column';
        btn.style.justifyContent = 'center';
        btn.style.alignItems = 'center';
        btn.style.transition = '0.2s';

        btn.onmouseenter = () => btn.style.transform = 'scale(1.05)';
        btn.onmouseleave = () => btn.style.transform = 'scale(1)';

        btn.innerHTML = `
          <div style="font-size:18px">${icons[type] || 'üîß'}</div>
          <div>${componentTypes[type].name}</div>
        `;

        panel.appendChild(btn);
      });
    }

    // Initialize SDK
    function initializeApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
              },
              {
                get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                set: (v) => { cfg.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); }
              },
              {
                get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                set: (v) => { cfg.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title]
          ])
        });
      }
      applyConfig();
      renderComponentPalette();
    }
    
    function applyConfig() {
      const title = document.getElementById('app-title');
      if (title) {
        title.textContent = `‚ö° ${config.app_title || defaultConfig.app_title} ‚ö°`;
      }
    }
    
    // Tab switching
    function switchTab(tab) {
      const builderTab = document.getElementById('builder-tab');
      const examplesTab = document.getElementById('examples-tab');
      const tabBuilder = document.getElementById('tab-builder');
      const tabExamples = document.getElementById('tab-examples');
      
      if (tab === 'builder') {
        builderTab.classList.remove('hidden');
        examplesTab.classList.add('hidden');
        tabBuilder.classList.add('tab-active');
        tabExamples.classList.remove('tab-active');
      } else {
        builderTab.classList.add('hidden');
        examplesTab.classList.remove('hidden');
        tabBuilder.classList.remove('tab-active');
        tabExamples.classList.add('tab-active');
      }
    }
    
    // Add component to canvas
    function addComponent(type) {
      const canvas = document.getElementById('canvas-container');
      const rect = canvas.getBoundingClientRect();
      const typeInfo = componentTypes[type];
      
      const component = {
        id: componentIdCounter++,
        type: type,
        x: 50 + Math.random() * (rect.width - 150),
        y: 50 + Math.random() * (rect.height - 150),
        rotation: 0, // Initialize rotation for all components
        ...typeInfo
      };
      
      components.push(component);
      renderComponents();
      updateStats();
    }
    
    // Toggle view mode between realistic and schematic
    function toggleViewMode() {
      viewMode = viewMode === 'realistic' ? 'schematic' : 'realistic';
      const btn = document.getElementById('view-mode-btn');
      btn.innerHTML = viewMode === 'realistic' ? 'üé® View: Realistic' : 'üé® View: Schematic';
      btn.classList.toggle('glow-gold', viewMode === 'schematic');
      
      // Stop existing electron animations
      stopElectrons();
      
      // Re-render components and wires
      renderComponents();
      renderWires();
      
      // Restart electron animations if circuit is powered
      if (circuitPowered) {
        testCircuit();
      }
    }
    
    // Function to generate realistic SVG for each component type
    function getRealisticSVG(type, closed = true, exploded = false, powered = false) {
      const opacity = exploded ? '0.5' : '1';
      const filter = exploded ? 'grayscale(1)' : 'none';
      
      switch(type) {
        case 'battery':
          return `
            <svg width="60" height="50" viewBox="0 0 60 50" style="opacity: ${opacity}; filter: ${filter};">
              <!-- Battery body -->
              <defs>
                <linearGradient id="battery-grad-${Math.random()}" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#1a1a1a;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#333;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#1a1a1a;stop-opacity:1" />
                </linearGradient>
              </defs>
              <rect x="15" y="15" width="30" height="20" rx="2" fill="url(#battery-grad-${Math.random()})" stroke="#555" stroke-width="1.5"/>
              <!-- Positive terminal -->
              <rect x="45" y="21" width="4" height="8" rx="1" fill="#C0C0C0" stroke="#888" stroke-width="0.5"/>
              <!-- Negative terminal -->
              <rect x="11" y="23" width="4" height="4" rx="0.5" fill="#C0C0C0" stroke="#888" stroke-width="0.5"/>
              <!-- Labels -->
              <circle cx="40" cy="25" r="3" fill="none" stroke="#DC2626" stroke-width="1"/>
              <text x="40" y="28" fill="#DC2626" font-size="6" text-anchor="middle" font-weight="bold">+</text>
              <circle cx="20" cy="25" r="3" fill="none" stroke="#3B82F6" stroke-width="1"/>
              <line x1="18" y1="25" x2="22" y2="25" stroke="#3B82F6" stroke-width="1"/>
              <!-- Brand label -->
              <text x="30" y="28" fill="#F59E0B" font-size="5" text-anchor="middle" font-weight="bold">9V</text>
            </svg>
          `;
          
        case 'resistor':
          return `
            <svg width="60" height="40" viewBox="0 0 60 40" style="opacity: ${opacity}; filter: ${filter};">
              <!-- Resistor body -->
              <defs>
                <linearGradient id="resistor-grad-${Math.random()}" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#D4A574;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#E8C9A0;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#D4A574;stop-opacity:1" />
                </linearGradient>
              </defs>
              <!-- Wire leads -->
              <line x1="0" y1="20" x2="10" y2="20" stroke="#C0C0C0" stroke-width="2"/>
              <line x1="50" y1="20" x2="60" y2="20" stroke="#C0C0C0" stroke-width="2"/>
              <!-- Body -->
              <rect x="10" y="14" width="40" height="12" rx="2" fill="url(#resistor-grad-${Math.random()})" stroke="#A67C52" stroke-width="1"/>
              <!-- Color bands -->
              <rect x="16" y="13" width="3" height="14" fill="#8B4513"/>
              <rect x="24" y="13" width="3" height="14" fill="#DC2626"/>
              <rect x="32" y="13" width="3" height="14" fill="#F59E0B"/>
              <rect x="42" y="13" width="3" height="14" fill="#D4AF37"/>
            </svg>
          `;
          
        case 'bulb':
          const glowColor = (powered && !exploded) ? '#FFF176' : '#666';
          const glowOpacity = (powered && !exploded) ? '0.8' : '0';
          const filamentColor = (powered && !exploded) ? '#FFF176' : (exploded ? '#1a1a1a' : '#333');
          const glassOpacity = exploded ? '0.3' : '1';
          
          return `
            <svg width="60" height="50" viewBox="0 0 60 50" style="opacity: ${opacity}; filter: ${filter};">
              <defs>
                <radialGradient id="bulb-glow-${Math.random()}" cx="50%" cy="40%">
                  <stop offset="0%" style="stop-color:${glowColor};stop-opacity:${glowOpacity}" />
                  <stop offset="70%" style="stop-color:${glowColor};stop-opacity:${parseFloat(glowOpacity) * 0.3}" />
                  <stop offset="100%" style="stop-color:${glowColor};stop-opacity:0" />
                </radialGradient>
                <linearGradient id="glass-grad-${Math.random()}" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.6" />
                  <stop offset="50%" style="stop-color:#e0e0e0;stop-opacity:0.4" />
                  <stop offset="100%" style="stop-color:#c0c0c0;stop-opacity:0.5" />
                </linearGradient>
              </defs>
              <!-- Wire leads -->
              <line x1="0" y1="35" x2="20" y2="35" stroke="#C0C0C0" stroke-width="2"/>
              <line x1="40" y1="35" x2="60" y2="35" stroke="#C0C0C0" stroke-width="2"/>
              <!-- Base -->
              <rect x="24" y="32" width="12" height="8" rx="1" fill="#888" stroke="#555" stroke-width="1"/>
              <rect x="22" y="40" width="16" height="3" rx="0.5" fill="#666" stroke="#444" stroke-width="0.5"/>
              <!-- Glass bulb -->
              <ellipse cx="30" cy="20" rx="12" ry="15" fill="url(#glass-grad-${Math.random()})" stroke="#999" stroke-width="1" opacity="${glassOpacity}"/>
              ${exploded ? `
                <!-- Crack lines when exploded -->
                <path d="M 22 18 L 30 25 L 38 15" stroke="#8B0000" stroke-width="1.5" fill="none"/>
                <path d="M 25 12 L 30 20 L 35 10" stroke="#8B0000" stroke-width="1" fill="none"/>
                <path d="M 30 10 L 30 30" stroke="#8B0000" stroke-width="1" fill="none"/>
              ` : ''}
              <!-- Glow effect when powered -->
              <circle cx="30" cy="20" r="18" fill="url(#bulb-glow-${Math.random()})" opacity="${powered && !exploded ? '1' : '0'}"/>
              <!-- Filament -->
              <path d="M 28 15 Q 26 20, 28 25" stroke="${filamentColor}" stroke-width="${exploded ? '1' : '1.5'}" fill="none"/>
              <path d="M 32 15 Q 34 20, 32 25" stroke="${filamentColor}" stroke-width="${exploded ? '1' : '1.5'}" fill="none"/>
              <line x1="28" y1="15" x2="32" y2="15" stroke="${filamentColor}" stroke-width="${exploded ? '0.5' : '1'}"/>
              <line x1="28" y1="25" x2="32" y2="25" stroke="${filamentColor}" stroke-width="${exploded ? '0.5' : '1'}"/>
              ${exploded ? `
                <!-- Broken filament indicator -->
                <circle cx="28" cy="20" r="1.5" fill="#DC2626"/>
                <circle cx="32" cy="20" r="1.5" fill="#DC2626"/>
                <text x="30" y="48" fill="#DC2626" font-size="6" text-anchor="middle" font-weight="bold">FAILED</text>
              ` : ''}
            </svg>
          `;
          
        case 'switch':
          if (closed) {
            return `
              <svg width="60" height="40" viewBox="0 0 60 40" style="opacity: ${opacity}; filter: ${filter};">
                <!-- Base -->
                <rect x="10" y="18" width="40" height="10" rx="2" fill="#2d2d2d" stroke="#555" stroke-width="1"/>
                <!-- Terminals -->
                <circle cx="15" cy="23" r="3" fill="#C0C0C0" stroke="#888" stroke-width="1"/>
                <circle cx="45" cy="23" r="3" fill="#C0C0C0" stroke="#888" stroke-width="1"/>
                <!-- Wire leads -->
                <line x1="0" y1="23" x2="12" y2="23" stroke="#C0C0C0" stroke-width="2"/>
                <line x1="48" y1="23" x2="60" y2="23" stroke="#C0C0C0" stroke-width="2"/>
                <!-- Toggle lever (closed position) -->
                <rect x="28" y="12" width="4" height="11" rx="2" fill="#DC2626" stroke="#991B1B" stroke-width="1"/>
                <circle cx="30" cy="12" r="3" fill="#EF4444" stroke="#991B1B" stroke-width="1"/>
                <!-- Connection bar -->
                <line x1="15" y1="23" x2="45" y2="23" stroke="#D97706" stroke-width="3"/>
              </svg>
            `;
          } else {
            return `
              <svg width="60" height="40" viewBox="0 0 60 40" style="opacity: ${opacity}; filter: ${filter};">
                <!-- Base -->
                <rect x="10" y="18" width="40" height="10" rx="2" fill="#2d2d2d" stroke="#555" stroke-width="1"/>
                <!-- Terminals -->
                <circle cx="15" cy="23" r="3" fill="#C0C0C0" stroke="#888" stroke-width="1"/>
                <circle cx="45" cy="23" r="3" fill="#C0C0C0" stroke="#888" stroke-width="1"/>
                <!-- Wire leads -->
                <line x1="0" y1="23" x2="12" y2="23" stroke="#C0C0C0" stroke-width="2"/>
                <line x1="48" y1="23" x2="60" y2="23" stroke="#C0C0C0" stroke-width="2"/>
                <!-- Toggle lever (open position) -->
                <rect x="28" y="22" width="4" height="11" rx="2" fill="#666" stroke="#444" stroke-width="1"/>
                <circle cx="30" cy="33" r="3" fill="#888" stroke="#444" stroke-width="1"/>
                <!-- No connection -->
              </svg>
            `;
          }
          
        case 'led':
          const ledColor = (powered && !exploded) ? '#DC2626' : (exploded ? '#1a0000' : '#4a0000');
          const ledGlow = (powered && !exploded) ? '1' : '0';
          const ledOpacity = exploded ? '0.4' : '0.9';
          
          return `
            <svg width="60" height="50" viewBox="0 0 60 50" style="opacity: ${opacity}; filter: ${filter};">
              <defs>
                <radialGradient id="led-glow-${Math.random()}" cx="50%" cy="50%">
                  <stop offset="0%" style="stop-color:#ff0000;stop-opacity:${ledGlow}" />
                  <stop offset="100%" style="stop-color:#ff0000;stop-opacity:0" />
                </radialGradient>
              </defs>
              <!-- Wire leads -->
              <line x1="0" y1="35" x2="18" y2="35" stroke="#C0C0C0" stroke-width="2"/>
              <line x1="42" y1="35" x2="60" y2="35" stroke="#C0C0C0" stroke-width="2"/>
              <!-- LED legs -->
              <line x1="24" y1="35" x2="24" y2="30" stroke="#C0C0C0" stroke-width="1.5"/>
              <line x1="36" y1="35" x2="36" y2="30" stroke="#C0C0C0" stroke-width="1.5"/>
              <!-- LED body (dome shape) -->
              <ellipse cx="30" cy="20" rx="9" ry="12" fill="${ledColor}" stroke="#8B0000" stroke-width="1.5" opacity="${ledOpacity}"/>
              ${exploded ? `
                <!-- Burn marks when failed -->
                <circle cx="30" cy="20" r="6" fill="#1a0000" opacity="0.8"/>
                <path d="M 26 18 L 34 22" stroke="#DC2626" stroke-width="0.5"/>
                <path d="M 26 22 L 34 18" stroke="#DC2626" stroke-width="0.5"/>
              ` : ''}
              <!-- Glow effect -->
              <circle cx="30" cy="20" r="15" fill="url(#led-glow-${Math.random()})" opacity="${powered && !exploded ? '0.7' : '0'}"/>
              <!-- Highlight on LED -->
              <ellipse cx="27" cy="16" rx="3" ry="4" fill="white" opacity="${exploded ? '0.1' : '0.4'}"/>
              <!-- Base -->
              <rect x="22" y="30" width="16" height="5" rx="1" fill="#333" stroke="#555" stroke-width="0.5"/>
              ${exploded ? `
                <text x="30" y="48" fill="#DC2626" font-size="6" text-anchor="middle" font-weight="bold">FAILED</text>
              ` : ''}
            </svg>
          `;
          
        case 'capacitor':
          return `
            <svg width="60" height="50" viewBox="0 0 60 50" style="opacity: ${opacity}; filter: ${filter};">
              <defs>
                <linearGradient id="cap-grad-${Math.random()}" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#4A5568;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#2D3748;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#1A202C;stop-opacity:1" />
                </linearGradient>
              </defs>
              <!-- Wire leads -->
              <line x1="0" y1="25" x2="22" y2="25" stroke="#C0C0C0" stroke-width="2"/>
              <line x1="38" y1="25" x2="60" y2="25" stroke="#C0C0C0" stroke-width="2"/>
              <!-- Capacitor body (cylinder) -->
              <rect x="22" y="10" width="16" height="30" rx="2" fill="url(#cap-grad-${Math.random()})" stroke="#555" stroke-width="1.5"/>
              <!-- Top cap -->
              <ellipse cx="30" cy="10" rx="8" ry="3" fill="#4A5568" stroke="#555" stroke-width="1"/>
              <!-- Stripe/band -->
              <rect x="22" y="18" width="16" height="4" fill="#F59E0B" opacity="0.8"/>
              <!-- Label -->
              <text x="30" y="27" fill="#FFF" font-size="6" text-anchor="middle" font-weight="bold">ŒºF</text>
              <!-- Polarity marking -->
              <text x="26" y="15" fill="#FFF" font-size="8" text-anchor="middle" font-weight="bold">-</text>
            </svg>
          `;
          const componentSymbols = {
  battery: 'üîã',
  resistor: '‚ö°',
  bulb: 'üí°',
  switch: '‚èª',
  led: 'üî¥',
  capacitor: '‚ïë‚ïë',
  thermistor: 'üå°Ô∏è',
  ldr: '‚òÄÔ∏è',
  varistor: 'üü†',
  fuse: 'üî•',
  motor: '‚öôÔ∏è',
  speaker: 'üîä',
  heater: '‚ô®Ô∏è',
  fan: 'üåÄ',
  relay: 'üîÅ',
  inductor: 'üß≤',
  zener: 'üîª',
  diode: '‚ñ∂|',
  potentiometer: 'üéöÔ∏è',
  transistor: 'üî∫',
  opamp: '‚ûï',
  ic: 'üíæ',
  photodiode: 'üì∏',
  buzzer: 'üîî',
  ammeter: 'üìä',
  voltmeter: 'üìü'
};
  return `
    <svg width="60" height="40" viewBox="0 0 60 40" style="opacity: ${opacity}; filter: ${filter};">
      <rect x="5" y="8" width="50" height="24" rx="6"
            fill="#2a2a2a"
            stroke="#F59E0B"
            stroke-width="2"/>
      <text x="30" y="25"
            text-anchor="middle"
            font-size="9"
            fill="#F59E0B"
            font-weight="bold">
        ${type.toUpperCase()}
      </text>
    </svg>
  `;
          
        default:
          return `<svg width="60" height="40"><rect width="60" height="40" fill="#333" stroke="#F59E0B"/></svg>`;
      }
    }
    
    // Function to generate schematic SVG for each component type
    function getSchematicSVG(type, closed = true, exploded = false) {
      const color = exploded ? '#666' : '#F59E0B';
      const strokeWidth = 2;
      
      switch(type) {
        case 'battery':
          return `
            <svg width="60" height="40" viewBox="0 0 60 40">
              <line x1="20" y1="5" x2="20" y2="35" stroke="${color}" stroke-width="${strokeWidth * 2}"/>
              <line x1="40" y1="10" x2="40" y2="30" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <text x="10" y="15" fill="${color}" font-size="12" font-weight="bold">+</text>
              <text x="45" y="15" fill="${color}" font-size="12" font-weight="bold">-</text>
            </svg>
          `;
          
        case 'resistor':
          return `
            <svg width="60" height="40" viewBox="0 0 60 40">
              <line x1="0" y1="20" x2="10" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <polyline points="10,20 15,10 20,30 25,10 30,30 35,10 40,30 45,10 50,20" 
                        fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="50" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
            </svg>
          `;
          
        case 'bulb':
          const glowFilter = exploded ? '' : 'filter="url(#bulb-glow)"';
          return `
            <svg width="60" height="40" viewBox="0 0 60 40">
              <defs>
                <radialGradient id="bulb-glow">
                  <stop offset="0%" stop-color="${color}" stop-opacity="0.8"/>
                  <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
                </radialGradient>
              </defs>
              <line x1="0" y1="20" x2="15" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <circle cx="30" cy="20" r="12" fill="none" stroke="${color}" stroke-width="${strokeWidth}" ${glowFilter}/>
              <line x1="24" y1="20" x2="36" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="30" y1="14" x2="30" y2="26" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="45" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
            </svg>
          `;
          
        case 'switch':
          if (closed) {
            return `
              <svg width="60" height="40" viewBox="0 0 60 40">
                <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
                <line x1="20" y1="20" x2="40" y2="20" stroke="${color}" stroke-width="${strokeWidth * 1.5}"/>
                <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
                <circle cx="20" cy="20" r="2" fill="${color}"/>
                <circle cx="40" cy="20" r="2" fill="${color}"/>
              </svg>
            `;
          } else {
            return `
              <svg width="60" height="40" viewBox="0 0 60 40">
                <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
                <line x1="20" y1="20" x2="38" y2="8" stroke="${color}" stroke-width="${strokeWidth * 1.5}"/>
                <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
                <circle cx="20" cy="20" r="2" fill="${color}"/>
                <circle cx="40" cy="20" r="2" fill="${color}"/>
              </svg>
            `;
          }
          
        case 'led':
          return `
            <svg width="60" height="40" viewBox="0 0 60 40">
              <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <polygon points="20,12 20,28 35,20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="35" y1="12" x2="35" y2="28" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="35" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <polyline points="30,8 34,4 32,4 36,0" fill="none" stroke="${color}" stroke-width="1"/>
              <polyline points="38,8 42,4 40,4 44,0" fill="none" stroke="${color}" stroke-width="1"/>
            </svg>
          `;
          
        case 'capacitor':
          return `
            <svg width="60" height="40" viewBox="0 0 60 40">
              <line x1="0" y1="20" x2="25" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
              <line x1="25" y1="8" x2="25" y2="32" stroke="${color}" stroke-width="${strokeWidth * 1.5}"/>
              <line x1="35" y1="8" x2="35" y2="32" stroke="${color}" stroke-width="${strokeWidth * 1.5}"/>
              <line x1="35" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
            </svg>
          `;
          case 'thermistor':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <line x1="0" y1="20" x2="10" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <polyline points="10,20 20,10 30,30 40,10 50,20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="50" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="25" y1="8" x2="35" y2="32" stroke="${color}" stroke-width="1"/>
    </svg>
  `;

case 'ldr':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <circle cx="30" cy="20" r="10" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <polyline points="15,5 20,0 18,0 22,-4" fill="none" stroke="${color}" stroke-width="1"/>
    </svg>
  `;

case 'varistor':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <rect x="20" y="12" width="20" height="16" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'fuse':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <rect x="22" y="15" width="16" height="10" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="22" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="38" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'motor':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <circle cx="30" cy="20" r="12" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <text x="30" y="24" text-anchor="middle" font-size="12" fill="${color}">M</text>
      <line x1="0" y1="20" x2="18" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="42" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'speaker':
case 'buzzer':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <polygon points="20,10 35,20 20,30" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="35" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'heater':
case 'fan':
case 'relay':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <rect x="20" y="10" width="20" height="20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'inductor':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <path d="M10 20 Q15 10 20 20 T30 20 T40 20 T50 20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="10" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="50" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'transistor':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <circle cx="30" cy="20" r="10" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="30" y1="10" x2="30" y2="0" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="20" y1="20" x2="0" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'opamp':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <polygon points="20,10 20,30 45,20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="15" x2="20" y2="15" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="25" x2="20" y2="25" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="45" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'ic':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <rect x="20" y="10" width="20" height="20" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="40" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;

case 'potentiometer':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <polyline points="10,20 15,10 20,30 25,10 30,30 35,10 40,30 45,10 50,20" 
        fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="30" y1="5" x2="30" y2="20" stroke="${color}" stroke-width="1.5"/>
      <line x1="0" y1="20" x2="10" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="50" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;
  
case 'diode':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <polygon points="20,10 35,20 20,30" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="35" y1="10" x2="35" y2="30" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="35" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;
  
case 'photodiode':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <line x1="0" y1="20" x2="20" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <polygon points="20,10 35,20 20,30" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="35" y1="10" x2="35" y2="30" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="35" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="15" y1="5" x2="25" y2="12" stroke="${color}" stroke-width="1"/>
      <line x1="20" y1="0" x2="30" y2="8" stroke="${color}" stroke-width="1"/>
    </svg>
  `;
case 'ammeter':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <circle cx="30" cy="20" r="12" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <text x="30" y="24" text-anchor="middle" font-size="12" fill="${color}">A</text>
      <line x1="0" y1="20" x2="18" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="42" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;
case 'voltmeter':
  return `
    <svg width="60" height="40" viewBox="0 0 60 40">
      <circle cx="30" cy="20" r="12" fill="none" stroke="${color}" stroke-width="${strokeWidth}"/>
      <text x="30" y="24" text-anchor="middle" font-size="12" fill="${color}">V</text>
      <line x1="0" y1="20" x2="18" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
      <line x1="42" y1="20" x2="60" y2="20" stroke="${color}" stroke-width="${strokeWidth}"/>
    </svg>
  `;
        default:
  const symbol = componentSymbols[type] || 'üîß';
  return `
    <svg width="60" height="50" viewBox="0 0 60 50"
         style="opacity: ${opacity}; filter: ${filter};">
         
      <rect x="5" y="5" width="50" height="40" rx="8"
            fill="#2a1a1a"
            stroke="#F59E0B"
            stroke-width="2"/>

      <text x="30" y="22"
            text-anchor="middle"
            font-size="18">
        ${symbol}
      </text>

      <text x="30" y="40"
            text-anchor="middle"
            font-size="7"
            fill="#F59E0B"
            font-weight="bold">
        ${type.toUpperCase()}
      </text>

    </svg>
  `;
      }
    }
    
    // Render all components
    function renderComponents() {
      const layer = document.getElementById('components-layer');
      layer.innerHTML = '';
      
      components.forEach(comp => {
        // Ensure rotation property exists for all components
        if (comp.rotation === undefined) comp.rotation = 0;
        const div = document.createElement('div');
        div.className = 'component absolute bg-gradient-to-br from-red-900 to-red-950 border-2 border-yellow-600 rounded-lg p-2 text-center shadow-lg';
        div.style.left = comp.x + 'px';
        div.style.top = comp.y + 'px';
        div.style.minWidth = '80px';
        div.dataset.id = comp.id;
        
        // Apply rotation around component center
        if (comp.rotation !== undefined && comp.rotation !== 0) {
          div.style.transform = `rotate(${comp.rotation}deg)`;
          div.style.transformOrigin = 'center center';
        } else {
          div.style.transform = '';
        }
        
        let valueDisplay = '';
        if (comp.hasValue) {
          if (comp.valueType === 'voltage') {
            valueDisplay = `<div class="editable-value text-xs mt-1" onclick="editValue(event, ${comp.id})">${comp.voltage}V</div>`;
          } else if (comp.valueType === 'resistance') {
            valueDisplay = `<div class="editable-value text-xs mt-1" onclick="editValue(event, ${comp.id})">${comp.resistance}Œ©</div>`;
          } else if (comp.valueType === 'capacitance') {
            valueDisplay = `<div class="editable-value text-xs mt-1" onclick="editValue(event, ${comp.id})">${comp.capacitance}¬µF</div>`;
          }
        }
        
        if (comp.type === 'switch') {
          valueDisplay = `<div class="editable-value text-xs mt-1 cursor-pointer" onclick="toggleSwitch(event, ${comp.id})">${comp.closed ? 'CLOSED' : 'OPEN'}</div>`;
        }

        // Display meter readout (voltmeter / ammeter)
        if (comp.type === 'voltmeter' || comp.type === 'ammeter') {
          const val = comp.displayValue !== undefined ? comp.displayValue : '--';
          valueDisplay = `<div class="text-xs mt-1 text-yellow-400">${val}</div>`;
        }

        // Always show resistance if present (non-invasive, non-editable)
        let resistanceDisplay = '';
        if (typeof comp.resistance === 'number') {
          resistanceDisplay = `<div class="text-xs mt-1 text-yellow-400">${comp.resistance}Œ©</div>`;
        }
        
        // Connection points
        const connPoints = `
          <div class="absolute -left-2 top-1/2 transform -translate-y-1/2 w-4 h-4 bg-yellow-500 rounded-full border-2 border-yellow-300 cursor-pointer hover:scale-125 transition-transform" 
               onclick="handleConnection(event, ${comp.id}, 'left')" data-terminal="left"></div>
          <div class="absolute -right-2 top-1/2 transform -translate-y-1/2 w-4 h-4 bg-yellow-500 rounded-full border-2 border-yellow-300 cursor-pointer hover:scale-125 transition-transform" 
               onclick="handleConnection(event, ${comp.id}, 'right')" data-terminal="right"></div>
        `;
        
        // Rotate button (always available) - calls rotateComponent with comp id
        const rotateBtn = `<button class="absolute top-1/2 -right-8 transform -translate-y-1/2 w-6 h-6 bg-yellow-600 rounded-full text-white text-xs hover:bg-yellow-500 flex items-center justify-center" onclick="rotateComponent(${comp.id})" title="Rotate">üîÑ</button>`;
        
        // Delete button
        const deleteBtn = `<button class="absolute -top-2 -right-2 w-5 h-5 bg-red-600 rounded-full text-white text-xs hover:bg-red-500" onclick="deleteComponent(event, ${comp.id})">√ó</button>`;
        
        // Get the appropriate SVG based on view mode
        let componentSVG;

if (viewMode === 'realistic') {

  componentSVG = getRealisticSVG(comp.type, comp.closed, comp.exploded, circuitPowered);

  // If fallback gray box is returned, replace with emoji card
  if (componentSVG.includes('fill="#333"')) {

    const emojiMap = {
      thermistor: 'üå°Ô∏è',
      ldr: '‚òÄÔ∏è',
      varistor: 'üü†',
      fuse: 'üî•',
      motor: '‚öôÔ∏è',
      speaker: 'üîä',
      heater: '‚ô®Ô∏è',
      fan: 'üåÄ',
      relay: 'üîÅ',
      inductor: 'üß≤',
      zener: 'üîª',
      diode: '‚ñ∂|',
      potentiometer: 'üéöÔ∏è',
      transistor: 'üî∫',
      opamp: '‚ûï',
      ic: 'üíæ',
      photodiode: 'üì∏',
      buzzer: 'üîî',
      ammeter: 'üìä',
      voltmeter: 'üìü'
    };

    const emoji = emojiMap[comp.type] || 'üîß';

    componentSVG = `
      <svg width="60" height="50" viewBox="0 0 60 50">
        <rect x="5" y="5" width="50" height="40" rx="8"
              fill="#2a1a1a"
              stroke="#F59E0B"
              stroke-width="2"/>
        <text x="30" y="25"
              text-anchor="middle"
              font-size="18">
          ${emoji}
        </text>
        <text x="30" y="42"
              text-anchor="middle"
              font-size="7"
              fill="#F59E0B"
              font-weight="bold">
          ${comp.type.toUpperCase()}
        </text>
      </svg>
    `;
  }

} else {

  componentSVG = getSchematicSVG(comp.type, comp.closed, comp.exploded);

}
        
        div.innerHTML = `
          <div class="flex justify-center mb-1 ${comp.exploded ? 'exploded' : ''}">${componentSVG}</div>
          <div class="text-xs text-yellow-400 font-bold">${comp.name}</div>
          ${valueDisplay}
          ${resistanceDisplay}
          ${connPoints}
          ${rotateBtn}
          ${deleteBtn}
        `;
        
        // Drag handlers
        div.addEventListener('mousedown', (e) => startDrag(e, comp));
        div.addEventListener('touchstart', (e) => startDrag(e, comp), { passive: false });
        
        layer.appendChild(div);
      });
    }
    
    // Rotate component (supports two call signatures)
    // rotateComponent(event, compId)  OR  rotateComponent(compId)
    function rotateComponent(a, b) {
      let compId;
      if (a && typeof a === 'object' && typeof a.stopPropagation === 'function') {
        // called as rotateComponent(event, compId)
        a.stopPropagation();
        compId = b;
      } else {
        // called as rotateComponent(compId)
        compId = a;
      }

      const comp = components.find(c => c.id === compId);
      if (!comp) return;

      if (comp.rotation === undefined) comp.rotation = 0;

      // Toggle between 0 and 90 degrees
      comp.rotation = (comp.rotation + 90) % 180;

      renderComponents();
      renderWires();
      if (circuitPowered) testCircuit();
    }
    
    // Edit component value
    function editValue(event, compId) {
      event.stopPropagation();
      const comp = components.find(c => c.id === compId);
      if (!comp) return;
      
      const target = event.target;
      const currentValue = comp.valueType === 'voltage' ? comp.voltage : 
                          comp.valueType === 'resistance' ? comp.resistance :
                          comp.capacitance;
      
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentValue;
      input.className = 'w-full bg-maroon text-yellow-400 text-xs text-center rounded border border-yellow-500 p-1';
      input.style.width = '60px';
      
      input.addEventListener('blur', () => {
        const newValue = parseFloat(input.value) || currentValue;
        if (comp.valueType === 'voltage') comp.voltage = newValue;
        else if (comp.valueType === 'resistance') comp.resistance = Math.max(1, newValue);
        else comp.capacitance = newValue;
        renderComponents();
        if (circuitPowered) testCircuit();
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') input.blur();
      });
      
      target.replaceWith(input);
      input.focus();
      input.select();
    }
    
    // Toggle switch
    function toggleSwitch(event, compId) {
      event.stopPropagation();
      const comp = components.find(c => c.id === compId);
      if (comp && comp.type === 'switch') {
        comp.closed = !comp.closed;
        renderComponents();
        if (circuitPowered) testCircuit();
      }
    }
    
    // Delete component
    function deleteComponent(event, compId) {
      event.stopPropagation();
      components = components.filter(c => c.id !== compId);
      wires = wires.filter(w => w.startId !== compId && w.endId !== compId);
      renderComponents();
      renderWires();
      updateStats();
      if (circuitPowered) testCircuit();
    }
    
    // Drag functionality
    function startDrag(e, comp) {
      // Don't drag if clicking terminal buttons or in wire mode
      if (e.target.dataset.terminal || wireMode || e.target.tagName === 'BUTTON') return;
      
      // Don't drag if clicking editable value
      if (e.target.classList.contains('editable-value')) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      draggedComponent = comp;
      
      const canvas = document.getElementById('canvas-container');
      const rect = canvas.getBoundingClientRect();
      
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      // Calculate offset from component's top-left corner
      dragOffset.x = clientX - rect.left - comp.x;
      dragOffset.y = clientY - rect.top - comp.y;
      
      // Add dragging class for visual feedback
      const compElement = document.querySelector(`[data-id="${comp.id}"]`);
      if (compElement) {
        compElement.classList.add('dragging');
      }
      
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchmove', onDrag, { passive: false });
      document.addEventListener('touchend', endDrag);
    }
    
    function onDrag(e) {
      if (!draggedComponent) return;
      e.preventDefault();
      
      const canvas = document.getElementById('canvas-container');
      const rect = canvas.getBoundingClientRect();
      
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      // Calculate new position
      const newX = clientX - rect.left - dragOffset.x;
      const newY = clientY - rect.top - dragOffset.y;
      
      // Constrain to canvas bounds
      draggedComponent.x = Math.max(0, Math.min(rect.width - 100, newX));
      draggedComponent.y = Math.max(0, Math.min(rect.height - 80, newY));
      
      renderComponents();
      renderWires();
    }
    
    function endDrag() {
      if (draggedComponent) {
        const compElement = document.querySelector(`[data-id="${draggedComponent.id}"]`);
        if (compElement) {
          compElement.classList.remove('dragging');
        }
      }
      
      draggedComponent = null;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', endDrag);
      document.removeEventListener('touchmove', onDrag);
      document.removeEventListener('touchend', endDrag);
    }
    
    // Wire mode
    function toggleWireMode() {
      wireMode = !wireMode;
      const btn = document.getElementById('wire-mode-btn');
      btn.innerHTML = wireMode ? 'üîå Wire Mode: ON' : 'üîå Wire Mode: OFF';
      btn.classList.toggle('glow-gold', wireMode);
      wireStart = null;
    }
    
    // Toggle schematic mode
    function toggleSchematicMode() {
      if (schematicMode && currentSchematic) {
        // Exiting example schematic - clear it
        clearCanvas();
        return;
      }
      
      schematicMode = !schematicMode;
      const btn = document.getElementById('schematic-mode-btn');
      btn.innerHTML = schematicMode ? 'üìê Schematic Mode: ON' : 'üìê Schematic Mode: OFF';
      btn.classList.toggle('glow-gold', schematicMode);
      
      // Stop existing electron animations
      stopElectrons();
      
      // Re-render with new mode
      if (schematicMode) {
        renderSchematicFromBuilder();
      } else {
        // Return to builder mode
        renderComponents();
        renderWires();
      }
      
      // Restart electron animations if circuit is powered
      if (circuitPowered) {
        testCircuit();
      }
    }
    
    // Handle wire connections
    function handleConnection(event, compId, terminal) {
      event.stopPropagation();
      
      if (!wireMode) return;
      
      if (!wireStart) {
        wireStart = { id: compId, terminal };
      } else {
        if (wireStart.id !== compId) {
          // Allow multiple wires per terminal ‚Äî do not block additional connections
          wires.push({
            startId: wireStart.id,
            startTerminal: wireStart.terminal,
            endId: compId,
            endTerminal: terminal
          });
          renderWires();
          updateStats();
        }
        wireStart = null;
      }
    }
    
    // CRITICAL: Node-based topology analysis with proper circuit detection
    function analyzeCircuitTopology() {
      // Build adjacency map: terminalId -> [connected terminalIds]
      const adjacency = new Map();
      
      // Helper to get terminal ID
      function getTerminalId(compId, terminal) {
        return `${compId}-${terminal}`;
      }
      
      // Initialize adjacency for all component terminals
      components.forEach(comp => {
        adjacency.set(getTerminalId(comp.id, 'left'), []);
        adjacency.set(getTerminalId(comp.id, 'right'), []);
      });
      
      // Add wire connections
      wires.forEach(wire => {
        const startTerminal = getTerminalId(wire.startId, wire.startTerminal);
        const endTerminal = getTerminalId(wire.endId, wire.endTerminal);
        
        if (adjacency.has(startTerminal) && adjacency.has(endTerminal)) {
          adjacency.get(startTerminal).push(endTerminal);
          adjacency.get(endTerminal).push(startTerminal);
        }
      });
      
      // Find electrical nodes using DFS (groups of connected terminals at same potential)
      const visited = new Set();
      const nodes = [];
      
      function dfs(terminalId, currentNode) {
        if (visited.has(terminalId)) return;
        visited.add(terminalId);
        currentNode.push(terminalId);
        
        const neighbors = adjacency.get(terminalId) || [];
        neighbors.forEach(neighbor => {
          if (!visited.has(neighbor)) {
            dfs(neighbor, currentNode);
          }
        });
      }
      
      // Build nodes (groups of connected terminals - electrical junctions)
      adjacency.forEach((_, terminalId) => {
        if (!visited.has(terminalId)) {
          const node = [];
          dfs(terminalId, node);
          nodes.push(node);
        }
      });
      
      // Identify components between each pair of nodes
      const componentsBetweenNodes = new Map();
      
      // For each resistive component, find which nodes its terminals belong to
      components.forEach(comp => {
        if (!comp.resistance) return;
        
        const leftTerminal = getTerminalId(comp.id, 'left');
        const rightTerminal = getTerminalId(comp.id, 'right');
        
        // Find nodes containing these terminals
        let leftNode = nodes.findIndex(node => node.includes(leftTerminal));
        let rightNode = nodes.findIndex(node => node.includes(rightTerminal));
        
        if (leftNode !== -1 && rightNode !== -1 && leftNode !== rightNode) {
          // Component connects two different nodes
          const nodeKey = [Math.min(leftNode, rightNode), Math.max(leftNode, rightNode)].join('-');
          
          if (!componentsBetweenNodes.has(nodeKey)) {
            componentsBetweenNodes.set(nodeKey, []);
          }
          componentsBetweenNodes.get(nodeKey).push(comp);
        }
      });
      
      // Identify parallel groups (multiple components between same node pair)
      const parallelGroups = [];
      let hasParallel = false;
      
      componentsBetweenNodes.forEach((comps, nodeKey) => {
        if (comps.length > 1) {
          // Parallel group detected - multiple current paths between same two nodes
          hasParallel = true;
          const reciprocalSum = comps.reduce((sum, comp) => sum + 1 / (comp.resistance || 1), 0);
          const equivalentResistance = 1 / reciprocalSum;
          
          parallelGroups.push({
            nodeKey,
            components: comps,
            resistance: equivalentResistance
          });
        }
      });
      
      // Determine circuit type
      let circuitType = 'Unknown';
      const resistiveComponents = components.filter(c => c.resistance);
      
      if (resistiveComponents.length === 0) {
        circuitType = 'No Load';
      } else if (componentsBetweenNodes.size === 0) {
        circuitType = 'Incomplete';
      } else if (!hasParallel && componentsBetweenNodes.size === resistiveComponents.length) {
        // All components are between different node pairs - pure series
        circuitType = 'Series';
      } else if (hasParallel && componentsBetweenNodes.size === 1) {
        // All components between same two nodes - pure parallel
        circuitType = 'Parallel';
      } else if (hasParallel) {
        // Mix of series and parallel
        circuitType = 'Mixed';
      } else {
        circuitType = 'Series';
      }
      
      return { 
        nodes, 
        componentsBetweenNodes, 
        parallelGroups, 
        circuitType,
        hasJunctions: nodes.some(node => node.length > 2) // A junction has 3+ terminals connected
      };
    }
    
    // Render wires
    function renderWires() {
      const layer = document.getElementById('wires-layer');
      layer.innerHTML = '';
      
      wires.forEach((wire, index) => {
        const startComp = components.find(c => c.id === wire.startId);
        const endComp = components.find(c => c.id === wire.endId);
        
        if (!startComp || !endComp) return;
        
        // Calculate center points of components
        const startX = startComp.x + 40; // Center of 80px wide component
        const startY = startComp.y + 35; // Center of 70px tall component
        const endX = endComp.x + 40;
        const endY = endComp.y + 35;
        
        if (schematicMode) {
          // SCHEMATIC MODE: Use orthogonal routing with 90¬∞ angles
          // Account for component rotation when calculating terminal positions
          
          // Helper function to get rotated terminal position
          function getRotatedTerminalPos(compX, compY, terminal, rotation = 0, componentType = null) {
            // CRITICAL: For batteries in horizontal orientation (0¬∞ or 180¬∞), 
            // position terminals inline (same Y) to allow straight wire pass-through
            
            // Determine if this is a battery component
            const isBattery = componentType === 'battery';
            
            // Base offset for terminal
            let offsetX = terminal === 'left' ? -40 : 40;
            let offsetY = 0;
            
            // SPECIAL HANDLING FOR BATTERIES:
            // When battery is horizontal (0¬∞ or 180¬∞), reduce the terminal offset
            // so wires can connect inline without forced bends
            if (isBattery && (rotation === 0 || rotation === 180)) {
              // Reduce offset to be at the edge of the battery symbol (~30px)
              offsetX = terminal === 'left' ? -30 : 30;
            } else if (isBattery && (rotation === 90 || rotation === 270)) {
              // When vertical, use standard offset
              offsetX = terminal === 'left' ? -40 : 40;
            }
            
            // Apply rotation transformation
            const rad = (rotation * Math.PI) / 180;
            const cos = Math.cos(rad);
            const sin = Math.sin(rad);
            
            // Rotate the offset vector
            const rotatedX = offsetX * cos - offsetY * sin;
            const rotatedY = offsetX * sin + offsetY * cos;
            
            return {
              x: compX + rotatedX,
              y: compY + rotatedY
            };
          }
          
          const startTerm = getRotatedTerminalPos(startX, startY, wire.startTerminal, startComp.rotation || 0, startComp.type);
          const endTerm = getRotatedTerminalPos(endX, endY, wire.endTerminal, endComp.rotation || 0, endComp.type);
          
          const startTermX = startTerm.x;
          const startTermY = startTerm.y;
          const endTermX = endTerm.x;
          const endTermY = endTerm.y;
          
          // Create wire group for click handling
          const wireGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          wireGroup.setAttribute('class', `wire ${circuitPowered ? 'powered' : ''}`);
          wireGroup.setAttribute('id', `wire-${index}`);
          wireGroup.style.cursor = 'pointer';
          
          // Calculate deltas
          const dx = endTermX - startTermX;
          const dy = endTermY - startTermY;
          
          // CRITICAL: Use larger threshold for horizontal alignment detection (¬±10px tolerance)
          if (Math.abs(dy) < 10) {
            // Horizontally aligned - render as single straight line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startTermX);
            line.setAttribute('y1', startTermY);
            line.setAttribute('x2', endTermX);
            line.setAttribute('y2', startTermY); // Force same Y for perfectly horizontal line
            line.setAttribute('stroke', '#D97706');
            line.setAttribute('stroke-width', '3');
            line.setAttribute('fill', 'none');
            wireGroup.appendChild(line);
          } else if (Math.abs(dx) < 10) {
            // Vertically aligned - render as single straight line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startTermX);
            line.setAttribute('y1', startTermY);
            line.setAttribute('x2', startTermX); // Force same X for perfectly vertical line
            line.setAttribute('y2', endTermY);
            line.setAttribute('stroke', '#D97706');
            line.setAttribute('stroke-width', '3');
            line.setAttribute('fill', 'none');
            wireGroup.appendChild(line);
          } else {
            // Not aligned - use L-shaped or Z-shaped routing with 90¬∞ angles
            const midX = startTermX + dx / 2;
            
            // Horizontal from start terminal
            const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line1.setAttribute('x1', startTermX);
            line1.setAttribute('y1', startTermY);
            line1.setAttribute('x2', midX);
            line1.setAttribute('y2', startTermY);
            line1.setAttribute('stroke', '#D97706');
            line1.setAttribute('stroke-width', '3');
            line1.setAttribute('fill', 'none');
            wireGroup.appendChild(line1);
            
            // Vertical connector
            const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line2.setAttribute('x1', midX);
            line2.setAttribute('y1', startTermY);
            line2.setAttribute('x2', midX);
            line2.setAttribute('y2', endTermY);
            line2.setAttribute('stroke', '#D97706');
            line2.setAttribute('stroke-width', '3');
            line2.setAttribute('fill', 'none');
            wireGroup.appendChild(line2);
            
            // Horizontal to end terminal
            const line3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line3.setAttribute('x1', midX);
            line3.setAttribute('y1', endTermY);
            line3.setAttribute('x2', endTermX);
            line3.setAttribute('y2', endTermY);
            line3.setAttribute('stroke', '#D97706');
            line3.setAttribute('stroke-width', '3');
            line3.setAttribute('fill', 'none');
            wireGroup.appendChild(line3);
          }
          
          // Click to delete wire
          wireGroup.addEventListener('click', () => {
            wires.splice(index, 1);
            renderWires();
            updateStats();
            if (circuitPowered) testCircuit();
          });
          
          layer.appendChild(wireGroup);
        } else {
          // BUILDER MODE or EXAMPLE SCHEMATIC: Use free-form straight line
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', startX);
          line.setAttribute('y1', startY);
          line.setAttribute('x2', endX);
          line.setAttribute('y2', endY);
          line.setAttribute('class', `wire ${circuitPowered ? 'powered' : ''}`);
          line.setAttribute('id', `wire-${index}`);
          
          // Click to delete wire
          line.style.cursor = 'pointer';
          line.addEventListener('click', () => {
            wires.splice(index, 1);
            renderWires();
            updateStats();
            if (circuitPowered) testCircuit();
          });
          
          layer.appendChild(line);
        }
      });
    }
    
    // Update stats
    function updateStats() {
      document.getElementById('stat-batteries').textContent = components.filter(c => c.type === 'battery').length;
      document.getElementById('stat-resistors').textContent = components.filter(c => c.type === 'resistor').length;
      document.getElementById('stat-bulbs').textContent = components.filter(c => ['bulb', 'led'].includes(c.type)).length;
      document.getElementById('stat-wires').textContent = wires.length;
    }
    
    // Helper: Gaussian Elimination for solving Ax = b
    function gaussianElimination(A, b) {
      const n = A.length;
      const x = new Array(n).fill(0);
      const M = A.map(row => [...row]);
      const v = [...b];
      
      for (let i = 0; i < n; i++) {
        let pivot = i;
        for (let j = i + 1; j < n; j++) {
          if (Math.abs(M[j][i]) > Math.abs(M[pivot][i])) pivot = j;
        }
        [M[i], M[pivot]] = [M[pivot], M[i]];
        [v[i], v[pivot]] = [v[pivot], v[i]];
        if (Math.abs(M[i][i]) < 1e-10) continue; 
        for (let j = i + 1; j < n; j++) {
          const factor = M[j][i] / M[i][i];
          for (let k = i; k < n; k++) {
            M[j][k] -= factor * M[i][k];
          }
          v[j] -= factor * v[i];
        }
      }
      for (let i = n - 1; i >= 0; i--) {
        if (Math.abs(M[i][i]) < 1e-10) continue;
        let sum = 0;
        for (let j = i + 1; j < n; j++) {
          sum += M[i][j] * x[j];
        }
        x[i] = (v[i] - sum) / M[i][i];
      }
      return x;
    }

    // Helper: Solve Circuit using Modified Nodal Analysis (MNA)
    function solveCircuitMNA(nodes, components) {
      const numNodes = nodes.length;
      if (numNodes < 2) return null;
      const terminalToNode = new Map();
      nodes.forEach((group, idx) => { group.forEach(term => terminalToNode.set(term, idx)); });
      const voltageSources = components.filter(c => c.type === 'battery');
      const resistors = components.filter(c => ['resistor', 'bulb', 'led'].includes(c.type));
      let groundNode = 0;
      if (voltageSources.length > 0) {
        const bat = voltageSources[0];
        const negTerm = `${bat.id}-left`;
        const n = terminalToNode.get(negTerm);
        if (n !== undefined) groundNode = n;
      }
      const nodeMap = new Array(numNodes).fill(-1);
      let matrixIdx = 0;
      for (let i = 0; i < numNodes; i++) { if (i !== groundNode) nodeMap[i] = matrixIdx++; }
      const numUnknowns = (numNodes - 1) + voltageSources.length;
      const A = Array(numUnknowns).fill().map(() => Array(numUnknowns).fill(0));
      const b = Array(numUnknowns).fill(0);

      resistors.forEach(r => {
        const n1 = terminalToNode.get(`${r.id}-left`);
        const n2 = terminalToNode.get(`${r.id}-right`);
        if (n1 === undefined || n2 === undefined || n1 === n2) return;
        const R = Math.max(1e-3, r.resistance || 1); 
        const g = 1 / R;
        const i1 = nodeMap[n1];
        const i2 = nodeMap[n2];
        if (i1 !== -1) A[i1][i1] += g;
        if (i2 !== -1) A[i2][i2] += g;
        if (i1 !== -1 && i2 !== -1) { A[i1][i2] -= g; A[i2][i1] -= g; }
      });

      voltageSources.forEach((v, vIdx) => {
        const nNeg = terminalToNode.get(`${v.id}-left`);
        const nPos = terminalToNode.get(`${v.id}-right`);
        if (nNeg === undefined || nPos === undefined) return;
        const row = (numNodes - 1) + vIdx;
        const voltage = v.voltage || 9;
        const iPos = nodeMap[nPos];
        const iNeg = nodeMap[nNeg];
        if (iPos !== -1) { A[row][iPos] = 1; A[iPos][row] = 1; }
        if (iNeg !== -1) { A[row][iNeg] = -1; A[iNeg][row] = -1; }
        b[row] = voltage;
      });

      const x = gaussianElimination(A, b);
      const voltages = new Array(numNodes).fill(0);
      for (let i = 0; i < numNodes; i++) { if (i !== groundNode) voltages[i] = x[nodeMap[i]]; }
      return voltages;
    }

    // Test circuit
    function testCircuit() {
      // CRITICAL: If in schematic mode, run schematic analysis instead
      if (schematicMode && currentSchematic) {
        analyzeSchematic(currentSchematic);
        return;
      }
      
      circuitPowered = true;
      
      const batteries = components.filter(c => c.type === 'battery');
      const switches = components.filter(c => c.type === 'switch');
      const resistiveComponents = components.filter(c => c.resistance);
      
      // Reset exploded state
      components.forEach(c => c.exploded = false);
      
      // Check for open switches
      const openSwitch = switches.find(s => !s.closed);
      
      // CRITICAL: Perform node-based topology analysis
      const { nodes, componentsBetweenNodes, parallelGroups, circuitType, hasJunctions } = analyzeCircuitTopology();

      // If purely parallel, auto-align for a clean textbook layout
      if (circuitType === 'Parallel') {
        try { autoAlignParallel(); } catch (e) { /* non-fatal */ }
      }
      
      // Calculate totals using topology-aware analysis
      const totalVoltage = batteries.reduce((sum, b) => sum + (b.voltage || 0), 0);
      let totalResistance = 0;
      
      // Calculate total resistance based on detected topology
      if (circuitType === 'Parallel') {
        // Pure parallel - all components between same two nodes
        const reciprocalSum = resistiveComponents.reduce((sum, r) => sum + 1 / (r.resistance || 1), 0);
        totalResistance = 1 / reciprocalSum;
      } else if (circuitType === 'Mixed') {
        // Mixed circuit - combine series and parallel
        for (const [key, comps] of componentsBetweenNodes.entries()) {
          if (comps.length === 1) {
            // Single component - add directly (series)
            totalResistance += comps[0].resistance || 0;
          } else {
            // Parallel group - find the group and use its equivalent resistance
            const group = parallelGroups.find(g => g.components === comps);
            if (group) {
              totalResistance += group.resistance;
            }
          }
        }
      } else if (circuitType === 'Series') {
        // Pure series circuit - sum all resistances
        totalResistance = resistiveComponents.reduce((sum, r) => sum + (r.resistance || 0), 0);
      }
      
      // Calculate component analysis for voltage/current distribution
      const componentAnalysis = [];
      if (totalResistance > 0) {
        const totalCurrent = totalVoltage / totalResistance;
        
        for (const [key, comps] of componentsBetweenNodes.entries()) {
          if (comps.length === 1) {
            // Series component - full current, voltage drop
            const comp = comps[0];
            const voltage = totalCurrent * comp.resistance;
            componentAnalysis.push({ comp, current: totalCurrent, voltage });
          } else {
            // Parallel group - voltage same, current splits
            const group = parallelGroups.find(g => g.components === comps);
            if (group) {
              const groupVoltage = totalCurrent * group.resistance;
              comps.forEach(comp => {
                const branchCurrent = groupVoltage / comp.resistance;
                componentAnalysis.push({ comp, current: branchCurrent, voltage: groupVoltage });
              });
            }
          }
        }
      }
      
      // ===== Meter readouts (safe, non-invasive) =====
      try {
        // Build terminal -> node mapping from topology analysis
        const terminalToNode = new Map();
        nodes.forEach((nodeArr, idx) => nodeArr.forEach(t => terminalToNode.set(t, idx)));

        // Run solver to obtain node voltages (does not modify solver)
        const nodeVoltages = solveCircuitMNA(nodes, components);
        if (Array.isArray(nodeVoltages)) {
          components.forEach(c => {
            if (c.type === 'voltmeter' || c.type === 'ammeter') {
              const leftTerm = `${c.id}-left`;
              const rightTerm = `${c.id}-right`;
              const nL = terminalToNode.get(leftTerm);
              const nR = terminalToNode.get(rightTerm);
              const vL = (nL !== undefined && nodeVoltages[nL] !== undefined) ? nodeVoltages[nL] : 0;
              const vR = (nR !== undefined && nodeVoltages[nR] !== undefined) ? nodeVoltages[nR] : 0;
              const diff = vL - vR;

              if (c.type === 'voltmeter') {
                c.displayValue = `${diff.toFixed(3)} V`;
              } else if (c.type === 'ammeter') {
                const r = (typeof c.resistance === 'number' && c.resistance > 0) ? c.resistance : 0.01;
                const current = diff / r;
                c.displayValue = `${Math.abs(current).toFixed(4)} A`;
              }
            }
          });
        }
      } catch (err) {
        // non-fatal: meters remain unset
      }

      let statusHTML = '';
      let computationHTML = '';
      let formulasHTML = '';
      
      if (batteries.length === 0) {
        statusHTML = `
          <div class="text-center">
            <span class="text-3xl">üîã</span>
            <p class="text-yellow-400 mt-2">Add a battery to power the circuit!</p>
          </div>
        `;
        circuitPowered = false;
      } else if (openSwitch) {
        statusHTML = `
          <div class="text-center">
            <span class="text-3xl">   </span>
            <p class="text-red-400 font-bold mt-2">Circuit OPEN</p>
            <p class="text-yellow-400/60 text-xs">A switch is open - no current flows</p>
          </div>
        `;
        circuitPowered = false;
      } else if (totalResistance === 0 && wires.length > 0) {
        statusHTML = `
          <div class="text-center">
            <span class="text-3xl">‚ö†Ô∏è</span>
            <p class="text-red-400 font-bold mt-2">SHORT CIRCUIT!</p>
            <p class="text-yellow-400/60 text-xs">Add resistors to protect the circuit</p>
          </div>
        `;
      } else if (wires.length === 0) {
        statusHTML = `
          <div class="text-center">
            <span class="text-3xl">üîå</span>
            <p class="text-yellow-400 mt-2">Connect components with wires!</p>
            <p class="text-yellow-400/60 text-xs">Enable Wire Mode and click terminals</p>
          </div>
        `;
        circuitPowered = false;
      } else {
        // Calculate circuit values
        const current = totalVoltage / totalResistance;
        const power = totalVoltage * current;
        
        // Check for exploded bulbs (realistic failure behavior)
        let explodedBulbs = [];
        componentAnalysis.forEach(({ comp, current: compCurrent, voltage }) => {
          // Fuse protection: blow fuse if current exceeds rating
          if (comp.type === 'fuse' && compCurrent > (comp.maxCurrent || 2)) {
            comp.exploded = true;
            comp.failureReason = 'Fuse blown!';
            explodedBulbs.push(comp);
            return; // skip other checks for this component
          }

          if (comp.type === 'bulb' || comp.type === 'led') {
            // Check voltage rating
            const maxVoltage = comp.maxVoltage || 15;
            const voltageExceeded = voltage > maxVoltage;
            
            // Check power rating (P = V * I)
            const maxPower = comp.maxPower || (maxVoltage * maxVoltage / comp.resistance);
            const actualPower = voltage * compCurrent;
            const powerExceeded = actualPower > maxPower;
            
            if (voltageExceeded || powerExceeded) {
              comp.exploded = true;
              comp.failureReason = voltageExceeded ? 
                `Voltage exceeded (${voltage.toFixed(2)}V > ${maxVoltage}V)` : 
                `Power exceeded (${actualPower.toFixed(2)}W > ${maxPower.toFixed(2)}W)`;
              explodedBulbs.push(comp);
            }
          }
        });
        
        let currentStatus = '';
        if (current < 0.1) currentStatus = 'üêå Very Low';
        else if (current < 0.5) currentStatus = 'üö∂ Low';
        else if (current < 2) currentStatus = '     Medium';
        else if (current < 5) currentStatus = '‚ö° High';
        else currentStatus = 'üî• Very High!';
        
        statusHTML = `
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Status:</span>
              <span class="text-green-400 font-bold">${explodedBulbs.length > 0 ? '‚ö†Ô∏è FAULT' : '‚úÖ WORKING'}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Circuit Type:</span>
              <span class="text-yellow-400 font-bold">${circuitType}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Voltage:</span>
              <span class="text-yellow-400 font-bold">${totalVoltage.toFixed(2)} V</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Total Resistance:</span>
              <span class="text-yellow-400 font-bold">${totalResistance.toFixed(2)} Œ©</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Current:</span>
              <span class="text-yellow-400 font-bold">${current.toFixed(3)} A ${currentStatus}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-yellow-400/80">Power:</span>
              <span class="text-yellow-400 font-bold">${power.toFixed(2)} W</span>
            </div>
            ${explodedBulbs.length > 0 ? `
              <div class="bg-red-900/50 border border-red-500 rounded p-2 mt-2">
                <p class="text-red-400 font-bold text-xs">üí• ${explodedBulbs.length} component(s) failed!</p>
                ${explodedBulbs.map(b => `
                  <p class="text-red-300 text-xs mt-1">‚Ä¢ ${b.name}: ${b.failureReason}</p>
                `).join('')}
                <p class="text-red-300 text-xs mt-2 italic">Circuit is now open - no current flows</p>
              </div>
            ` : ''}
          </div>
        `;
        
        // Computation steps with topology awareness
        let computationSteps = `<div class="space-y-2">`;
        
        computationSteps += `
          <div class="bg-black/30 p-2 rounded">
            <strong class="text-yellow-400">Circuit Type Detected:</strong>
            <p class="text-yellow-400/60">${circuitType}</p>
            ${hasJunctions ? '<p class="text-yellow-400/60 text-xs">‚ö†Ô∏è Circuit contains junctions (branch points)</p>' : ''}
          </div>
        `;
        
        computationSteps += `
          <div class="bg-black/30 p-2 rounded">
            <strong class="text-yellow-400">Step 1: Sum Voltages</strong>
            <p class="text-yellow-400/60">${batteries.map(b => b.voltage + 'V').join(' + ')} = ${totalVoltage}V</p>
          </div>
        `;
        
        if (circuitType === 'Parallel') {
          const reciprocals = resistiveComponents.map(r => `1/${r.resistance}`).join(' + ');
          const reciprocalSum = resistiveComponents.reduce((sum, r) => sum + 1/r.resistance, 0);
          
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step 2: Parallel Resistance Formula</strong>
              <p class="text-yellow-400/60">1/R_total = ${reciprocals}</p>
              <p class="text-yellow-400/60">1/R_total = ${reciprocalSum.toFixed(4)}</p>
              <p class="text-yellow-400/60">R_total = ${totalResistance.toFixed(2)}Œ©</p>
            </div>
          `;
        } else if (circuitType === 'Mixed') {
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step 2: Identify Topology</strong>
              <p class="text-yellow-400/60">Detected ${parallelGroups.length} parallel group(s)</p>
            </div>
          `;
          
          parallelGroups.forEach((group, idx) => {
            const reciprocals = group.components.map(c => `1/${c.resistance}`).join(' + ');
            const reciprocalSum = group.components.reduce((sum, c) => sum + 1/c.resistance, 0);
            
            computationSteps += `
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step ${3 + idx}: Parallel Group ${idx + 1}</strong>
                <p class="text-yellow-400/60">Components: ${group.components.map(c => `${c.name}(${c.resistance}Œ©)`).join(', ')}</p>
                <p class="text-yellow-400/60">1/R_parallel = ${reciprocals}</p>
                <p class="text-yellow-400/60">1/R_parallel = ${reciprocalSum.toFixed(4)}</p>
                <p class="text-yellow-400/60">R_parallel = ${group.resistance.toFixed(2)}Œ©</p>
              </div>
            `;
          });
          
          const nextStep = 3 + parallelGroups.length;
          const seriesComponents = [];
          for (const [key, comps] of componentsBetweenNodes.entries()) {
            if (comps.length === 1) {
              seriesComponents.push(comps[0].resistance);
            } else {
              const group = parallelGroups.find(g => g.components === comps);
              seriesComponents.push(group.resistance);
            }
          }
          
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step ${nextStep}: Total Resistance (Series)</strong>
              <p class="text-yellow-400/60">R_total = ${seriesComponents.map(r => r.toFixed(2) + 'Œ©').join(' + ')}</p>
              <p class="text-yellow-400/60">R_total = ${totalResistance.toFixed(2)}Œ©</p>
            </div>
          `;
          
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step ${nextStep + 1}: Total Current</strong>
              <p class="text-yellow-400/60">I = V / R = ${totalVoltage} / ${totalResistance.toFixed(2)} = ${current.toFixed(3)}A</p>
            </div>
          `;
        } else if (circuitType === 'Series') {
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step 2: Total Resistance (Series)</strong>
              <p class="text-yellow-400/60">${resistiveComponents.map(r => r.resistance + 'Œ©').join(' + ')} = ${totalResistance.toFixed(2)}Œ©</p>
            </div>
          `;
          
          computationSteps += `
            <div class="bg-black/30 p-2 rounded">
              <strong class="text-yellow-400">Step 3: Calculate Current</strong>
              <p class="text-yellow-400/60">I = V / R = ${totalVoltage} / ${totalResistance.toFixed(2)} = ${current.toFixed(3)}A</p>
            </div>
          `;
        }
        
        computationSteps += `
          <div class="bg-black/30 p-2 rounded">
            <strong class="text-yellow-400">Component Analysis:</strong>
        `;
        
        componentAnalysis.forEach(({ comp, current: compCurrent, voltage }) => {
          computationSteps += `
            <p class="text-yellow-400/60 mt-1">‚Ä¢ ${comp.name} (${comp.resistance}Œ©):</p>
            <p class="text-yellow-400/60 ml-3">V = ${voltage.toFixed(2)}V, I = ${compCurrent.toFixed(3)}A</p>
          `;
        });
        
        computationSteps += `</div>`;
        
        computationSteps += `
          <div class="bg-black/30 p-2 rounded">
            <strong class="text-yellow-400">Total Power:</strong>
            <p class="text-yellow-400/60">P = V √ó I = ${totalVoltage} √ó ${current.toFixed(3)} = ${power.toFixed(2)}W</p>
          </div>
        `;
        
        computationSteps += `</div>`;
        
        computationHTML = computationSteps;
        
        formulasHTML = `
          <div class="space-y-1 font-mono text-xs">
            <p>‚Ä¢ Ohm's Law: V = I √ó R</p>
            <p>‚Ä¢ Current: I = V / R</p>
            <p>‚Ä¢ Power: P = V √ó I = I¬≤R = V¬≤/R</p>
            <p>‚Ä¢ Series: R_total = R1 + R2 + ...</p>
            <p>‚Ä¢ Parallel: 1/R_total = 1/R1 + 1/R2 + ...</p>
            <p>‚Ä¢ Kirchhoff's Current Law (KCL)</p>
            <p>‚Ä¢ Kirchhoff's Voltage Law (KVL)</p>
          </div>
        `;
        
        // Start/stop electron animation only when circuit is physically closed
        if (!explodedBulbs.length) {
          // Basic gating: batteries, resistance, wires, switches, and sufficient current
          const hasBattery = batteries.length > 0;
          const hasResistance = totalResistance > 0;
          const hasWires = wires.length > 0;
          const noOpenSwitches = !openSwitch;
          const sufficientCurrent = (typeof current === 'number') && current > 0.0001;

          // Determine closed loop by checking node connectivity between battery terminals
          let closedLoop = false;
          try {
            // componentsBetweenNodes maps node pairs ("i-j") -> [components]
            // Build adjacency between node indices from that map
            const adj = new Map();
            for (const key of componentsBetweenNodes.keys()) {
              const parts = key.split('-').map(p => Number(p));
              if (parts.length !== 2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1])) continue;
              const a = parts[0], b = parts[1];
              if (!adj.has(a)) adj.set(a, new Set());
              if (!adj.has(b)) adj.set(b, new Set());
              adj.get(a).add(b);
              adj.get(b).add(a);
            }

            // Helper to find node index containing a terminal id
            function findNodeIndex(term) {
              for (let i = 0; i < nodes.length; i++) {
                if (nodes[i].includes(term)) return i;
              }
              return -1;
            }

            // At least one battery must have its terminals connected through resistive graph
            for (const bat of batteries) {
              const leftTerm = `${bat.id}-left`;
              const rightTerm = `${bat.id}-right`;
              const nL = findNodeIndex(leftTerm);
              const nR = findNodeIndex(rightTerm);
              if (nL === -1 || nR === -1) continue;

              // BFS from nL to see if nR reachable via component edges
              const q = [nL];
              const seen = new Set([nL]);
              while (q.length) {
                const cur = q.shift();
                if (cur === nR) { closedLoop = true; break; }
                const neighbors = adj.get(cur) || new Set();
                for (const nb of neighbors) {
                  if (!seen.has(nb)) { seen.add(nb); q.push(nb); }
                }
              }
              if (closedLoop) break;
            }
          } catch (err) {
            closedLoop = false;
          }

          if (hasBattery && hasResistance && hasWires && noOpenSwitches && sufficientCurrent && closedLoop) {
            startElectrons(current);
          } else {
            stopElectrons();
          }
        } else {
          stopElectrons(); // Stop electrons - circuit is open due to bulb failure
        }
      }
      
      document.getElementById('circuit-status').innerHTML = statusHTML;
      document.getElementById('computation-steps').innerHTML = computationHTML;
      document.getElementById('formulas-used').innerHTML = formulasHTML;
      
      renderComponents();
      renderWires();
    }
    
    

    // Auto align parallel resistors into a textbook layout
    function autoAlignParallel() {
      const resistors = components.filter(c => c.type === 'resistor');
      const battery = components.find(c => c.type === 'battery');

      if (!battery || resistors.length < 2) return;

      const topY = 150;
      const bottomY = 350;
      const startX = 250;
      const spacing = 140;

      resistors.forEach((r, index) => {
        r.x = startX + index * spacing;
        r.y = (topY + bottomY) / 2;
        r.rotation = 90;
      });

      renderComponents();
      renderWires();
    }
    
    // Toggle solution visibility
    function toggleSolution() {
      solutionVisible = !solutionVisible;
      const panel = document.getElementById('solution-panel');
      const btn = document.getElementById('solution-toggle');
      
      panel.classList.toggle('hidden', !solutionVisible);
      btn.innerHTML = solutionVisible ? 'üëÅÔ∏è Hide Solution' : 'üëÅÔ∏è Show Solution';
    }
    
    // Toggle example solutions
    function toggleExampleSolution(type) {
      const solution = document.getElementById(`${type}-solution`);
      const btn = document.getElementById(`${type}-solution-btn`);
      
      solution.classList.toggle('hidden');
      btn.innerHTML = solution.classList.contains('hidden') ? 'üëÅÔ∏è Show' : 'üëÅÔ∏è Hide';
    }
    
    // Render schematic directly on canvas
    function renderSchematic(type) {
      const svg = document.getElementById('circuit-svg');
      const wiresLayer = document.getElementById('wires-layer');
      const componentsLayer = document.getElementById('components-layer');
      
      // Clear existing content
      wiresLayer.innerHTML = '';
      componentsLayer.innerHTML = '';
      
      // CRITICAL: Reset any existing transforms on the SVG
      svg.setAttribute('viewBox', '');
      svg.removeAttribute('transform');
      
      // Get canvas dimensions
      const canvas = document.getElementById('canvas-container');
      const canvasWidth = canvas.offsetWidth;
      const canvasHeight = canvas.offsetHeight;
      
      // Create a group for the schematic WITHOUT any initial transform
      const schematicGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      schematicGroup.setAttribute('id', 'schematic-group');
      
      // Define schematic properties
      let schematicSVG = '';
      let viewBoxWidth = 400;
      let viewBoxHeight = 120;
      let schematicBounds = { minX: 0, minY: 0, maxX: 400, maxY: 120 };
      
      switch(type) {
        case 'series':
          viewBoxWidth = 400;
          viewBoxHeight = 120;
          schematicBounds = { minX: 20, minY: 20, maxX: 360, maxY: 110 };
          schematicSVG = `
            <!-- Battery -->
            <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2"/>
            <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4"/>
            <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2"/>
            <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">12V</text>
            
            <!-- Wire from battery -->
            <line x1="60" y1="60" x2="100" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-0"/>
            
            <!-- Resistor 1 -->
            <path d="M100,60 L110,60 L115,50 L125,70 L135,50 L145,70 L150,60 L160,60" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="130" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">R1=10Œ©</text>
            
            <!-- Wire -->
            <line x1="160" y1="60" x2="200" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-1"/>
            
            <!-- Resistor 2 -->
            <path d="M200,60 L210,60 L215,50 L225,70 L235,50 L245,70 L250,60 L260,60" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="230" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">R2=20Œ©</text>
            
            <!-- Wire -->
            <line x1="260" y1="60" x2="300" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-2"/>
            
            <!-- Bulb -->
            <circle cx="320" cy="60" r="15" fill="none" stroke="#D97706" stroke-width="2" id="schematic-bulb"/>
            <path d="M310,60 L330,60 M320,50 L320,70" stroke="#F59E0B" stroke-width="1"/>
            <text x="320" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">R3=10Œ©</text>
            
            <!-- Return wire -->
            <line x1="335" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-3"/>
            <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-4"/>
            <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-5"/>
            <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-6"/>
          `;
          break;
          
        case 'parallel':
          viewBoxWidth = 400;
          viewBoxHeight = 120;
          schematicBounds = { minX: 20, minY: 20, maxX: 360, maxY: 115 };
          schematicSVG = `
            <!-- Battery -->
            <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2"/>
            <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4"/>
            <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2"/>
            <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">12V</text>
            
            <!-- Main wire to junction -->
            <line x1="60" y1="60" x2="120" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-0"/>
            
            <!-- Junction point top -->
            <circle cx="120" cy="60" r="4" fill="#F59E0B"/>
            
            <!-- Top branch -->
            <line x1="120" y1="60" x2="120" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-1"/>
            <line x1="120" y1="30" x2="180" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-2"/>
            <path d="M180,30 L190,30 L195,20 L205,40 L215,20 L225,40 L230,30 L240,30" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="210" y="15" fill="#F59E0B" font-size="10" text-anchor="middle">R1=20Œ©</text>
            <line x1="240" y1="30" x2="300" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-3"/>
            
            <!-- Bottom branch -->
            <line x1="120" y1="60" x2="120" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-4"/>
            <line x1="120" y1="90" x2="180" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-5"/>
            <path d="M180,90 L190,90 L195,80 L205,100 L215,80 L225,100 L230,90 L240,90" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="210" y="115" fill="#F59E0B" font-size="10" text-anchor="middle">R2=30Œ©</text>
            <line x1="240" y1="90" x2="300" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-6"/>
            
            <!-- Junction point right -->
            <circle cx="300" cy="60" r="4" fill="#F59E0B"/>
            <line x1="300" y1="30" x2="300" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-7"/>
            
            <!-- Return wire -->
            <line x1="300" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-8"/>
            <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-9"/>
            <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-10"/>
            <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-11"/>
          `;
          break;
          
        case 'mixed':
          viewBoxWidth = 400;
          viewBoxHeight = 120;
          schematicBounds = { minX: 20, minY: 18, maxX: 360, maxY: 140 };
          schematicSVG = `
            <!-- Battery -->
            <rect x="20" y="45" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2"/>
            <line x1="30" y1="50" x2="30" y2="70" stroke="#F59E0B" stroke-width="4"/>
            <line x1="50" y1="55" x2="50" y2="65" stroke="#F59E0B" stroke-width="2"/>
            <text x="40" y="90" fill="#F59E0B" font-size="10" text-anchor="middle">24V</text>
            
            <!-- Series resistor -->
            <line x1="60" y1="60" x2="80" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-0"/>
            <path d="M80,60 L90,60 L95,50 L105,70 L115,50 L125,70 L130,60 L140,60" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="110" y="40" fill="#F59E0B" font-size="10" text-anchor="middle">R1=8Œ©</text>
            
            <!-- Junction to parallel -->
            <line x1="140" y1="60" x2="160" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-1"/>
            <circle cx="160" cy="60" r="4" fill="#F59E0B"/>
            
            <!-- Parallel section -->
            <line x1="160" y1="60" x2="160" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-2"/>
            <line x1="160" y1="30" x2="200" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-3"/>
            <path d="M200,30 L205,30 L208,22 L214,38 L220,22 L226,38 L230,30 L235,30" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="218" y="18" fill="#F59E0B" font-size="8" text-anchor="middle">R2=12Œ©</text>
            <line x1="235" y1="30" x2="280" y2="30" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-4"/>
            
            <line x1="160" y1="60" x2="160" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-5"/>
            <line x1="160" y1="90" x2="200" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-6"/>
            <path d="M200,90 L205,90 L208,82 L214,98 L220,82 L226,98 L230,90 L235,90" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="218" y="110" fill="#F59E0B" font-size="8" text-anchor="middle">R3=12Œ©</text>
            <line x1="235" y1="90" x2="280" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-7"/>
            
            <circle cx="280" cy="60" r="4" fill="#F59E0B"/>
            <line x1="280" y1="30" x2="280" y2="90" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-8"/>
            
            <!-- Bulb after parallel -->
            <line x1="280" y1="60" x2="310" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-9"/>
            <circle cx="330" cy="60" r="12" fill="none" stroke="#D97706" stroke-width="2" id="schematic-bulb"/>
            <path d="M322,60 L338,60 M330,52 L330,68" stroke="#F59E0B" stroke-width="1"/>
            <text x="330" y="85" fill="#F59E0B" font-size="8" text-anchor="middle">R4=10Œ©</text>
            
            <!-- Return -->
            <line x1="342" y1="60" x2="360" y2="60" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-10"/>
            <line x1="360" y1="60" x2="360" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-11"/>
            <line x1="360" y1="110" x2="20" y2="110" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-12"/>
            <line x1="20" y1="110" x2="20" y2="75" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-13"/>
          `;
          break;
          
        case 'divider':
          viewBoxWidth = 400;
          viewBoxHeight = 180;
          schematicBounds = { minX: 50, minY: 15, maxX: 300, maxY: 165 };
          schematicSVG = `
            <!-- Battery -->
            <rect x="50" y="20" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2"/>
            <line x1="60" y1="25" x2="60" y2="45" stroke="#F59E0B" stroke-width="4"/>
            <line x1="80" y1="30" x2="80" y2="40" stroke="#F59E0B" stroke-width="2"/>
            <text x="70" y="15" fill="#F59E0B" font-size="10" text-anchor="middle">9V</text>
            
            <!-- Top wire -->
            <line x1="90" y1="35" x2="200" y2="35" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-0"/>
            
            <!-- R1 vertical -->
            <path d="M200,35 L200,45 L190,50 L210,60 L190,70 L210,80 L200,85 L200,95" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="230" y="65" fill="#F59E0B" font-size="10" text-anchor="start">R1=3kŒ©</text>
            
            <!-- Vout point -->
            <circle cx="200" cy="95" r="4" fill="#F59E0B"/>
            <line x1="200" y1="95" x2="280" y2="95" stroke="#D97706" stroke-width="3" stroke-dasharray="5,3" class="wire" id="schematic-wire-1"/>
            <text x="300" y="98" fill="#DC2626" font-size="12" text-anchor="start">Vout</text>
            
            <!-- R2 vertical -->
            <path d="M200,95 L200,100 L190,105 L210,115 L190,125 L210,135 L200,140 L200,145" fill="none" stroke="#D97706" stroke-width="2"/>
            <text x="230" y="125" fill="#F59E0B" font-size="10" text-anchor="start">R2=1kŒ©</text>
            
            <!-- Ground symbol -->
            <line x1="200" y1="145" x2="200" y2="155" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-2"/>
            <line x1="185" y1="155" x2="215" y2="155" stroke="#D97706" stroke-width="3"/>
            <line x1="190" y1="160" x2="210" y2="160" stroke="#D97706" stroke-width="2"/>
            <line x1="195" y1="165" x2="205" y2="165" stroke="#D97706" stroke-width="1"/>
            
            <!-- Return to battery -->
            <line x1="50" y1="50" x2="50" y2="155" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-3"/>
            <line x1="50" y1="155" x2="185" y2="155" stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-4"/>
          `;
          break;
      }
      
      // First, render the schematic WITHOUT any transform
      schematicGroup.innerHTML = schematicSVG;
      wiresLayer.appendChild(schematicGroup);
      
      // CRITICAL: Calculate actual bounding box from world coordinates
      const schematicCenterX = (schematicBounds.minX + schematicBounds.maxX) / 2;
      const schematicCenterY = (schematicBounds.minY + schematicBounds.maxY) / 2;
      const schematicWidth = schematicBounds.maxX - schematicBounds.minX;
      const schematicHeight = schematicBounds.maxY - schematicBounds.minY;
      
      // Calculate scale to fit canvas (with margins)
      const margin = 50;
      const scaleX = (canvasWidth - 2 * margin) / schematicWidth;
      const scaleY = (canvasHeight - 2 * margin) / schematicHeight;
      const scale = Math.min(scaleX, scaleY, 2); // Cap at 2x to avoid too large
      
      // Calculate canvas center
      const canvasCenterX = canvasWidth / 2;
      const canvasCenterY = canvasHeight / 2;
      
      // Calculate translation to center the schematic
      // We need to translate so that schematicCenter * scale aligns with canvasCenter
      const offsetX = canvasCenterX - (schematicCenterX * scale);
      const offsetY = canvasCenterY - (schematicCenterY * scale);
      
      // Apply transform to center and scale the schematic group
      schematicGroup.setAttribute('transform', `translate(${offsetX}, ${offsetY}) scale(${scale})`);
    }
    
    // Convert builder circuit to schematic view
    function renderSchematicFromBuilder() {
      const svg = document.getElementById('circuit-svg');
      const wiresLayer = document.getElementById('wires-layer');
      const componentsLayer = document.getElementById('components-layer');
      
      // Clear existing content
      wiresLayer.innerHTML = '';
      componentsLayer.innerHTML = '';
      
      if (components.length === 0) {
        return;
      }
      
      // Get canvas dimensions
      const canvas = document.getElementById('canvas-container');
      const canvasWidth = canvas.offsetWidth;
      const canvasHeight = canvas.offsetHeight;
      
      // Create a group for the schematic
      const schematicGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      schematicGroup.setAttribute('id', 'schematic-group');
      
      // Grid size for snapping
      const gridSize = 40;
      
      // Calculate grid positions for all components (snap to grid)
      const componentPositions = new Map();
      let minGridX = Infinity, maxGridX = -Infinity;
      let minGridY = Infinity, maxGridY = -Infinity;
      
      components.forEach(comp => {
        const gridX = Math.round(comp.x / gridSize) * gridSize;
        const gridY = Math.round(comp.y / gridSize) * gridSize;
        componentPositions.set(comp.id, { x: gridX, y: gridY });
        
        minGridX = Math.min(minGridX, gridX);
        maxGridX = Math.max(maxGridX, gridX);
        minGridY = Math.min(minGridY, gridY);
        maxGridY = Math.max(maxGridY, gridY);
      });
      
      // Calculate bounding box
      const schematicWidth = maxGridX - minGridX + 100;
      const schematicHeight = maxGridY - minGridY + 100;
      const schematicCenterX = (minGridX + maxGridX) / 2;
      const schematicCenterY = (minGridY + maxGridY) / 2;
      
      let schematicSVG = '';
      let wireIndex = 0;
      
      // Render wires first (behind components)
      wires.forEach(wire => {
        const startComp = components.find(c => c.id === wire.startId);
        const endComp = components.find(c => c.id === wire.endId);
        
        if (!startComp || !endComp) return;
        
        const startPos = componentPositions.get(wire.startId);
        const endPos = componentPositions.get(wire.endId);
        
        // Calculate terminal positions (left = -30px, right = +30px from center)
        const startX = startPos.x + (wire.startTerminal === 'left' ? -30 : 30);
        const startY = startPos.y;
        const endX = endPos.x + (wire.endTerminal === 'left' ? -30 : 30);
        const endY = endPos.y;
        
        // Draw orthogonal wire (straight lines with right angles)
        const midX = (startX + endX) / 2;
        
        if (Math.abs(startY - endY) < 5) {
          // Horizontal wire
          schematicSVG += `
            <line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" 
                  stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-${wireIndex}"/>
          `;
        } else if (Math.abs(startX - endX) < 5) {
          // Vertical wire
          schematicSVG += `
            <line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" 
                  stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-${wireIndex}"/>
          `;
        } else {
          // L-shaped wire with right angle
          schematicSVG += `
            <line x1="${startX}" y1="${startY}" x2="${midX}" y2="${startY}" 
                  stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-${wireIndex}-a"/>
            <line x1="${midX}" y1="${startY}" x2="${midX}" y2="${endY}" 
                  stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-${wireIndex}-b"/>
            <line x1="${midX}" y1="${endY}" x2="${endX}" y2="${endY}" 
                  stroke="#D97706" stroke-width="3" class="wire" id="schematic-wire-${wireIndex}-c"/>
          `;
        }
        
        wireIndex++;
      });
      
      // Render components with schematic symbols
      components.forEach(comp => {
        const pos = componentPositions.get(comp.id);
        const cx = pos.x;
        const cy = pos.y;
        
        let valueLabel = '';
        if (comp.type === 'battery') {
          valueLabel = `${comp.voltage}V`;
        } else if (comp.type === 'resistor' || comp.type === 'bulb' || comp.type === 'led') {
          valueLabel = `${comp.resistance}Œ©`;
        } else if (comp.type === 'capacitor') {
          valueLabel = `${comp.capacitance}¬µF`;
        }
        
        // Render schematic symbol centered at (cx, cy)
        switch(comp.type) {
          case 'battery':
            schematicSVG += `
              <g transform="translate(${cx - 30}, ${cy - 20})">
                <rect x="20" y="5" width="40" height="30" fill="none" stroke="#D97706" stroke-width="2"/>
                <line x1="30" y1="10" x2="30" y2="30" stroke="#F59E0B" stroke-width="4"/>
                <line x1="50" y1="15" x2="50" y2="25" stroke="#F59E0B" stroke-width="2"/>
                <line x1="0" y1="20" x2="20" y2="20" stroke="#D97706" stroke-width="3"/>
                <line x1="60" y1="20" x2="80" y2="20" stroke="#D97706" stroke-width="3"/>
                <text x="40" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
              </g>
            `;
            break;
            
          case 'resistor':
            schematicSVG += `
              <g transform="translate(${cx - 30}, ${cy - 20})">
                <line x1="0" y1="20" x2="10" y2="20" stroke="#D97706" stroke-width="3"/>
                <polyline points="10,20 15,10 20,30 25,10 30,30 35,10 40,30 45,10 50,20" 
                          fill="none" stroke="#D97706" stroke-width="2"/>
                <line x1="50" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                <text x="30" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
              </g>
            `;
            break;
            
          case 'bulb':
            const glowClass = comp.exploded ? '' : (circuitPowered ? 'bulb-glow' : '');
            schematicSVG += `
              <g transform="translate(${cx - 30}, ${cy - 20})">
                <line x1="0" y1="20" x2="15" y2="20" stroke="#D97706" stroke-width="3"/>
                <circle cx="30" cy="20" r="12" fill="none" stroke="#D97706" stroke-width="2" class="${glowClass}" id="schematic-bulb-${comp.id}"/>
                <line x1="24" y1="20" x2="36" y2="20" stroke="#F59E0B" stroke-width="2"/>
                <line x1="30" y1="14" x2="30" y2="26" stroke="#F59E0B" stroke-width="2"/>
                <line x1="45" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                <text x="30" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
              </g>
            `;
            break;
            
          case 'switch':
            if (comp.closed) {
              schematicSVG += `
                <g transform="translate(${cx - 30}, ${cy - 20})">
                  <line x1="0" y1="20" x2="20" y2="20" stroke="#D97706" stroke-width="3"/>
                  <line x1="20" y1="20" x2="40" y2="20" stroke="#D97706" stroke-width="3"/>
                  <line x1="40" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                  <circle cx="20" cy="20" r="2" fill="#F59E0B"/>
                  <circle cx="40" cy="20" r="2" fill="#F59E0B"/>
                  <text x="30" y="35" fill="#F59E0B" font-size="8" text-anchor="middle">CLOSED</text>
                </g>
              `;
            } else {
              schematicSVG += `
                <g transform="translate(${cx - 30}, ${cy - 20})">
                  <line x1="0" y1="20" x2="20" y2="20" stroke="#D97706" stroke-width="3"/>
                  <line x1="20" y1="20" x2="38" y2="8" stroke="#D97706" stroke-width="3"/>
                  <line x1="40" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                  <circle cx="20" cy="20" r="2" fill="#F59E0B"/>
                  <circle cx="40" cy="20" r="2" fill="#F59E0B"/>
                  <text x="30" y="35" fill="#F59E0B" font-size="8" text-anchor="middle">OPEN</text>
                </g>
              `;
            }
            break;
            
          case 'led':
            schematicSVG += `
              <g transform="translate(${cx - 30}, ${cy - 20})">
                <line x1="0" y1="20" x2="20" y2="20" stroke="#D97706" stroke-width="3"/>
                <polygon points="20,12 20,28 35,20" fill="none" stroke="#D97706" stroke-width="2"/>
                <line x1="35" y1="12" x2="35" y2="28" stroke="#D97706" stroke-width="2"/>
                <line x1="35" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                <polyline points="30,8 34,4 32,4 36,0" fill="none" stroke="#F59E0B" stroke-width="1"/>
                <polyline points="38,8 42,4 40,4 44,0" fill="none" stroke="#F59E0B" stroke-width="1"/>
                <text x="30" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
              </g>
            `;
            break;
            
          case 'capacitor':
            schematicSVG += `
              <g transform="translate(${cx - 30}, ${cy - 20})">
                <line x1="0" y1="20" x2="25" y2="20" stroke="#D97706" stroke-width="3"/>
                <line x1="25" y1="8" x2="25" y2="32" stroke="#D97706" stroke-width="3"/>
                <line x1="35" y1="8" x2="35" y2="32" stroke="#D97706" stroke-width="3"/>
                <line x1="35" y1="20" x2="60" y2="20" stroke="#D97706" stroke-width="3"/>
                <text x="30" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
              </g>
            `;
            break;
            case 'thermistor':
case 'potentiometer':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <polyline points="5,25 15,20 25,30 35,20 45,30 55,25"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <line x1="30" y1="5" x2="30" y2="45"
        stroke="#D97706" stroke-width="2"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'ldr':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <circle cx="30" cy="25" r="15"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <line x1="10" y1="5" x2="20" y2="15"
        stroke="#D97706" stroke-width="2"/>
      <line x1="40" y1="5" x2="50" y2="15"
        stroke="#D97706" stroke-width="2"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'varistor':
case 'relay':
case 'heater':
case 'fan':
case 'ic':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <rect x="15" y="15" width="30" height="20"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'fuse':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <rect x="20" y="20" width="20" height="10"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="45" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'motor':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <circle cx="30" cy="25" r="15"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="28" fill="#D97706" font-size="12" text-anchor="middle">M</text>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'speaker':
case 'buzzer':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <polygon points="20,15 40,25 20,35"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'inductor':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <path d="M10 25 Q15 10 20 25 Q25 10 30 25 Q35 10 40 25 Q45 10 50 25"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'zener':
case 'diode':
case 'photodiode':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <polygon points="20,15 40,25 20,35"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <line x1="40" y1="15" x2="40" y2="35"
        stroke="#D97706" stroke-width="3"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'transistor':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <circle cx="30" cy="25" r="15"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <line x1="30" y1="10" x2="30" y2="40"
        stroke="#D97706" stroke-width="2"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'opamp':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <polygon points="15,10 15,40 45,25"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="50" fill="#F59E0B" font-size="10" text-anchor="middle">${valueLabel}</text>
    </g>
  `;
  break;

case 'ammeter':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <circle cx="30" cy="25" r="15"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="28" fill="#D97706" font-size="12" text-anchor="middle">A</text>
    </g>
  `;
  break;

case 'voltmeter':
  schematicSVG += `
    <g transform="translate(${cx - 30}, ${cy - 20})">
      <circle cx="30" cy="25" r="15"
        stroke="#D97706" stroke-width="3" fill="none"/>
      <text x="30" y="28" fill="#D97706" font-size="12" text-anchor="middle">V</text>
    </g>
  `;
  break;
        }
      });
      
      // Render the schematic
      schematicGroup.innerHTML = schematicSVG;
      wiresLayer.appendChild(schematicGroup);
      
      // Calculate scale and position
      const margin = 50;
      const scaleX = (canvasWidth - 2 * margin) / schematicWidth;
      const scaleY = (canvasHeight - 2 * margin) / schematicHeight;
      const scale = Math.min(scaleX, scaleY, 1.5);
      
      const canvasCenterX = canvasWidth / 2;
      const canvasCenterY = canvasHeight / 2;
      
      const offsetX = canvasCenterX - (schematicCenterX * scale);
      const offsetY = canvasCenterY - (schematicCenterY * scale);
      
      schematicGroup.setAttribute('transform', `translate(${offsetX}, ${offsetY}) scale(${scale})`);
    }
    
    // Load example circuits
    function loadExample(type) {
      clearCanvas();
      
      // Enable schematic mode
      schematicMode = true;
      currentSchematic = type;
      
      // Create simulation components based on schematic type
      createSimulationModel(type);
      
      // Render the schematic directly
      renderSchematic(type);
      
      // Update stats based on simulation components
      updateStats();
      
      // Switch to builder tab to show canvas
      switchTab('builder');
      
      // Run circuit analysis based on schematic type
      setTimeout(() => analyzeSchematic(type), 300);
    }
    
    // Create simulation model for schematic
    function createSimulationModel(type) {
      // Clear existing components but keep schematic mode
      components = [];
      wires = [];
      
      switch(type) {
        case 'series':
          // Create components for series circuit
          components = [
            { id: 0, type: 'battery', voltage: 12, name: 'Battery', hasValue: true, valueType: 'voltage', x: 0, y: 0 },
            { id: 1, type: 'resistor', resistance: 10, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 2, type: 'resistor', resistance: 20, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 3, type: 'bulb', resistance: 10, maxVoltage: 15, name: 'Bulb', hasValue: true, valueType: 'resistance', x: 0, y: 0 }
          ];
          wires = [
            { startId: 0, startTerminal: 'right', endId: 1, endTerminal: 'left' },
            { startId: 1, startTerminal: 'right', endId: 2, endTerminal: 'left' },
            { startId: 2, startTerminal: 'right', endId: 3, endTerminal: 'left' },
            { startId: 3, startTerminal: 'right', endId: 0, endTerminal: 'left' }
          ];
          componentIdCounter = 4;
          break;
          
        case 'parallel':
          // Create components for parallel circuit
          components = [
            { id: 0, type: 'battery', voltage: 12, name: 'Battery', hasValue: true, valueType: 'voltage', x: 0, y: 0 },
            { id: 1, type: 'resistor', resistance: 20, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 2, type: 'resistor', resistance: 30, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 }
          ];
          wires = [
            { startId: 0, startTerminal: 'right', endId: 1, endTerminal: 'left' },
            { startId: 0, startTerminal: 'right', endId: 2, endTerminal: 'left' },
            { startId: 1, startTerminal: 'right', endId: 0, endTerminal: 'left' },
            { startId: 2, startTerminal: 'right', endId: 0, endTerminal: 'left' }
          ];
          componentIdCounter = 3;
          break;
          
        case 'mixed':
          // Create components for mixed circuit
          components = [
            { id: 0, type: 'battery', voltage: 24, name: 'Battery', hasValue: true, valueType: 'voltage', x: 0, y: 0 },
            { id: 1, type: 'resistor', resistance: 8, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 2, type: 'resistor', resistance: 12, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 3, type: 'resistor', resistance: 12, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 4, type: 'bulb', resistance: 10, maxVoltage: 15, name: 'Bulb', hasValue: true, valueType: 'resistance', x: 0, y: 0 }
          ];
          wires = [
            { startId: 0, startTerminal: 'right', endId: 1, endTerminal: 'left' },
            { startId: 1, startTerminal: 'right', endId: 2, endTerminal: 'left' },
            { startId: 1, startTerminal: 'right', endId: 3, endTerminal: 'left' },
            { startId: 2, startTerminal: 'right', endId: 4, endTerminal: 'left' },
            { startId: 3, startTerminal: 'right', endId: 4, endTerminal: 'left' },
            { startId: 4, startTerminal: 'right', endId: 0, endTerminal: 'left' }
          ];
          componentIdCounter = 5;
          break;
          
        case 'divider':
          // Create components for voltage divider
          components = [
            { id: 0, type: 'battery', voltage: 9, name: 'Battery', hasValue: true, valueType: 'voltage', x: 0, y: 0 },
            { id: 1, type: 'resistor', resistance: 3000, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 },
            { id: 2, type: 'resistor', resistance: 1000, name: 'Resistor', hasValue: true, valueType: 'resistance', x: 0, y: 0 }
          ];
          wires = [
            { startId: 0, startTerminal: 'right', endId: 1, endTerminal: 'left' },
            { startId: 1, startTerminal: 'right', endId: 2, endTerminal: 'left' },
            { startId: 2, startTerminal: 'right', endId: 0, endTerminal: 'left' }
          ];
          componentIdCounter = 3;
          break;
          
      }
    }
    
    // Analyze schematic circuit
    function analyzeSchematic(type) {
      circuitPowered = true;
      
      let statusHTML = '';
      let computationHTML = '';
      let formulasHTML = '';
      
      switch(type) {
        case 'series':
          const seriesV = 12;
          const seriesR = 10 + 20 + 10;
          const seriesI = seriesV / seriesR;
          const seriesP = seriesV * seriesI;
          
          statusHTML = `
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Status:</span>
                <span class="text-green-400 font-bold">‚úÖ WORKING</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Voltage:</span>
                <span class="text-yellow-400 font-bold">${seriesV.toFixed(2)} V</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Total Resistance:</span>
                <span class="text-yellow-400 font-bold">${seriesR.toFixed(2)} Œ©</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Current:</span>
                <span class="text-yellow-400 font-bold">${seriesI.toFixed(3)} A</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Power:</span>
                <span class="text-yellow-400 font-bold">${seriesP.toFixed(2)} W</span>
              </div>
            </div>
          `;
          
          computationHTML = `
            <div class="space-y-2">
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 1: Total Resistance</strong>
                <p class="text-yellow-400/60">R_total = R1 + R2 + R3 (Series)</p>
                <p class="text-yellow-400/60">R_total = 10 + 20 + 10 = ${seriesR}Œ©</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 2: Current (Ohm's Law)</strong>
                <p class="text-yellow-400/60">I = V / R_total</p>
                <p class="text-yellow-400/60">I = ${seriesV} / ${seriesR} = ${seriesI.toFixed(3)}A</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 3: Voltage Drops</strong>
                <p class="text-yellow-400/60">V1 = I √ó R1 = ${seriesI.toFixed(3)} √ó 10 = ${(seriesI * 10).toFixed(2)}V</p>
                <p class="text-yellow-400/60">V2 = I √ó R2 = ${seriesI.toFixed(3)} √ó 20 = ${(seriesI * 20).toFixed(2)}V</p>
                <p class="text-yellow-400/60">V3 = I √ó R3 = ${seriesI.toFixed(3)} √ó 10 = ${(seriesI * 10).toFixed(2)}V</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 4: Power</strong>
                <p class="text-yellow-400/60">P = V √ó I = ${seriesV} √ó ${seriesI.toFixed(3)} = ${seriesP.toFixed(2)}W</p>
              </div>
            </div>
          `;
          break;
          
        case 'parallel':
          const parallelV = 12;
          const parallelRtotal = 1 / (1/20 + 1/30);
          const parallelItotal = parallelV / parallelRtotal;
          const parallelI1 = parallelV / 20;
          const parallelI2 = parallelV / 30;
          const parallelP = parallelV * parallelItotal;
          
          statusHTML = `
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Status:</span>
                <span class="text-green-400 font-bold">‚úÖ WORKING</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Voltage:</span>
                <span class="text-yellow-400 font-bold">${parallelV.toFixed(2)} V</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Total Resistance:</span>
                <span class="text-yellow-400 font-bold">${parallelRtotal.toFixed(2)} Œ©</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Total Current:</span>
                <span class="text-yellow-400 font-bold">${parallelItotal.toFixed(3)} A</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Power:</span>
                <span class="text-yellow-400 font-bold">${parallelP.toFixed(2)} W</span>
              </div>
            </div>
          `;
          
          computationHTML = `
            <div class="space-y-2">
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 1: Total Resistance</strong>
                <p class="text-yellow-400/60">1/R_total = 1/R1 + 1/R2 (Parallel)</p>
                <p class="text-yellow-400/60">1/R_total = 1/20 + 1/30 = ${(1/20 + 1/30).toFixed(4)}</p>
                <p class="text-yellow-400/60">R_total = ${parallelRtotal.toFixed(2)}Œ©</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 2: Total Current</strong>
                <p class="text-yellow-400/60">I_total = V / R_total</p>
                <p class="text-yellow-400/60">I_total = ${parallelV} / ${parallelRtotal.toFixed(2)} = ${parallelItotal.toFixed(3)}A</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 3: Branch Currents</strong>
                <p class="text-yellow-400/60">I1 = V / R1 = ${parallelV} / 20 = ${parallelI1.toFixed(3)}A</p>
                <p class="text-yellow-400/60">I2 = V / R2 = ${parallelV} / 30 = ${parallelI2.toFixed(3)}A</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 4: Power</strong>
                <p class="text-yellow-400/60">P = V √ó I = ${parallelV} √ó ${parallelItotal.toFixed(3)} = ${parallelP.toFixed(2)}W</p>
              </div>
            </div>
          `;
          break;
          
        case 'mixed':
          const mixedV = 24;
          const mixedRparallel = 1 / (1/12 + 1/12);
          const mixedRtotal = 8 + mixedRparallel + 10;
          const mixedI = mixedV / mixedRtotal;
          const mixedVparallel = mixedI * mixedRparallel;
          const mixedI2 = mixedVparallel / 12;
          const mixedI3 = mixedVparallel / 12;
          
          statusHTML = `
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Status:</span>
                <span class="text-green-400 font-bold">‚úÖ WORKING</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Voltage:</span>
                <span class="text-yellow-400 font-bold">${mixedV.toFixed(2)} V</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Total Resistance:</span>
                <span class="text-yellow-400 font-bold">${mixedRtotal.toFixed(2)} Œ©</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Current:</span>
                <span class="text-yellow-400 font-bold">${mixedI.toFixed(3)} A</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Power:</span>
                <span class="text-yellow-400 font-bold">${(mixedV * mixedI).toFixed(2)} W</span>
              </div>
            </div>
          `;
          
          computationHTML = `
            <div class="space-y-2">
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 1: Parallel Combo</strong>
                <p class="text-yellow-400/60">1/R_p = 1/12 + 1/12 = 2/12 = 1/6</p>
                <p class="text-yellow-400/60">R_parallel = ${mixedRparallel.toFixed(2)}Œ©</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 2: Total Resistance</strong>
                <p class="text-yellow-400/60">R_total = R1 + R_parallel + R4</p>
                <p class="text-yellow-400/60">R_total = 8 + ${mixedRparallel.toFixed(2)} + 10 = ${mixedRtotal.toFixed(2)}Œ©</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 3: Total Current</strong>
                <p class="text-yellow-400/60">I = V / R_total = ${mixedV} / ${mixedRtotal.toFixed(2)} = ${mixedI.toFixed(3)}A</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 4: Voltage Drops</strong>
                <p class="text-yellow-400/60">V_R1 = ${mixedI.toFixed(3)} √ó 8 = ${(mixedI * 8).toFixed(2)}V</p>
                <p class="text-yellow-400/60">V_parallel = ${mixedI.toFixed(3)} √ó ${mixedRparallel.toFixed(2)} = ${mixedVparallel.toFixed(2)}V</p>
                <p class="text-yellow-400/60">V_R4 = ${mixedI.toFixed(3)} √ó 10 = ${(mixedI * 10).toFixed(2)}V</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Step 5: Branch Currents</strong>
                <p class="text-yellow-400/60">I_R2 = ${mixedVparallel.toFixed(2)}/12 = ${mixedI2.toFixed(3)}A</p>
                <p class="text-yellow-400/60">I_R3 = ${mixedVparallel.toFixed(2)}/12 = ${mixedI3.toFixed(3)}A</p>
              </div>
            </div>
          `;
          break;
          
        case 'divider':
          const dividerVin = 9;
          const dividerR1 = 3000;
          const dividerR2 = 1000;
          const dividerVout = dividerVin * (dividerR2 / (dividerR1 + dividerR2));
          const dividerI = dividerVin / (dividerR1 + dividerR2);
          
          statusHTML = `
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Status:</span>
                <span class="text-green-400 font-bold">‚úÖ WORKING</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Input Voltage:</span>
                <span class="text-yellow-400 font-bold">${dividerVin.toFixed(2)} V</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Output Voltage:</span>
                <span class="text-yellow-400 font-bold">${dividerVout.toFixed(2)} V</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Current:</span>
                <span class="text-yellow-400 font-bold">${(dividerI * 1000).toFixed(2)} mA</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-yellow-400/80">Power:</span>
                <span class="text-yellow-400 font-bold">${(dividerVin * dividerI).toFixed(3)} W</span>
              </div>
            </div>
          `;
          
          computationHTML = `
            <div class="space-y-2">
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Voltage Divider Formula</strong>
                <p class="font-mono text-yellow-400/60">Vout = Vin √ó (R2 / (R1 + R2))</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Calculation</strong>
                <p class="text-yellow-400/60">Vout = ${dividerVin} √ó (1000 / (3000 + 1000))</p>
                <p class="text-yellow-400/60">Vout = ${dividerVin} √ó (1000 / 4000)</p>
                <p class="text-yellow-400/60">Vout = ${dividerVin} √ó 0.25 = ${dividerVout.toFixed(2)}V</p>
              </div>
              <div class="bg-black/30 p-2 rounded">
                <strong class="text-yellow-400">Current</strong>
                <p class="text-yellow-400/60">I = Vin / (R1 + R2)</p>
                <p class="text-yellow-400/60">I = ${dividerVin} / 4000 = ${(dividerI * 1000).toFixed(2)}mA</p>
              </div>
            </div>
          `;
          break;
      }
      
      formulasHTML = `
        <div class="space-y-1 font-mono text-xs">
          <p>‚Ä¢ Ohm's Law: V = I √ó R</p>
          <p>      Current: I = V / R</p>
          <p>‚Ä¢ Power: P = V √ó I = I¬≤R = V¬≤/R</p>
          <p>‚Ä¢ Series: R_total = R1 + R2 + ...</p>
          <p>‚Ä¢ Parallel: 1/R_total = 1/R1 + 1/R2 + ...</p>
        </div>
      `;
      
      document.getElementById('circuit-status').innerHTML = statusHTML;
      document.getElementById('computation-steps').innerHTML = computationHTML;
      document.getElementById('formulas-used').innerHTML = formulasHTML;
      
      // Start electron animations
      startElectrons(1); // Use a default current value for schematics
    }
    
    // Center view function - repositions all components to canvas center
    function centerView() {
      // CRITICAL: If in schematic mode, re-center the schematic transform
      if (schematicMode && currentSchematic) {
        renderSchematic(currentSchematic);
        return;
      }
      
      if (components.length === 0) {
        return; // Nothing to center
      }
      
      // Calculate bounding box of ALL components INCLUDING their width and height
      const componentWidth = 80;  // Standard component width
      const componentHeight = 70; // Standard component height
      
      let minX = Infinity, maxX = -Infinity;
      let minY = Infinity, maxY = -Infinity;
      
      components.forEach(comp => {
        minX = Math.min(minX, comp.x);
        maxX = Math.max(maxX, comp.x + componentWidth);
        minY = Math.min(minY, comp.y);
        maxY = Math.max(maxY, comp.y + componentHeight);
      });
      
      // Calculate the center of the bounding box
      const boundingBoxCenterX = (minX + maxX) / 2;
      const boundingBoxCenterY = (minY + maxY) / 2;
      
      // Get canvas dimensions
      const canvas = document.getElementById('canvas-container');
      const canvasWidth = canvas.offsetWidth;
      const canvasHeight = canvas.offsetHeight;
      
      // Calculate canvas center
      const canvasCenterX = canvasWidth / 2;
      const canvasCenterY = canvasHeight / 2;
      
      // Calculate translation needed to align bounding box center with canvas center
      const translateX = canvasCenterX - boundingBoxCenterX;
      const translateY = canvasCenterY - boundingBoxCenterY;
      
      // Apply translation to ALL components
      components.forEach(comp => {
        comp.x += translateX;
        comp.y += translateY;
      });
      
      // Re-render everything
      renderComponents();
      renderWires();
    }
    
    // Clear canvas
    function clearCanvas() {
      components = [];
      wires = [];
      schematicMode = false;
      currentSchematic = null;
      stopElectrons();
      renderComponents();
      renderWires();
      updateStats();
      
      // Reset schematic mode button
      const btn = document.getElementById('schematic-mode-btn');
      if (btn) {
        btn.innerHTML = 'üìê Schematic Mode: OFF';
        btn.classList.remove('glow-gold');
      }
      
      document.getElementById('circuit-status').innerHTML = `
        <div class="text-center text-yellow-400/60">
          Build a circuit to see analysis
        </div>
      `;
      document.getElementById('computation-steps').innerHTML = '';
      document.getElementById('formulas-used').innerHTML = '';
    }
    
    // Initialize on load
    initializeApp();
    
    // ===== ELECTRON ANIMATION =====
    // Uses actual SVG wire geometry (line & path) and requestAnimationFrame.
    // Keeps animation inside #electrons-layer and respects transforms/CTM so
    // schematicMode and scaled/transformed groups are handled automatically.
    (function(){
      // Merge global state
      window.electronAnimState = window.electronAnimState || { rafId: null, electrons: [], lastTime: 0, running: false };
      electronAnimState = window.electronAnimState; // keep local reference in sync

      function createSVGCircle(r = 3, fill = '#F59E0B') {
        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        c.setAttribute('r', String(r));
        c.setAttribute('class', 'electron');
        c.setAttribute('fill', fill);
        return c;
      }

      function addPoweredClassesIfSchematic() {
        try {
          const wiresLayer = document.getElementById('wires-layer');
          const schematicGroup = wiresLayer && wiresLayer.querySelector('#schematic-group');
          if (schematicGroup) {
            schematicGroup.querySelectorAll('.wire').forEach(w => w.classList.add('powered'));
            const schematicBulb = schematicGroup.querySelector('#schematic-bulb');
            if (schematicBulb) schematicBulb.classList.add('bulb-glow');
          }
        } catch (e) { /* no-op */ }
      }

      function removePoweredClassesIfSchematic() {
        try {
          const wiresLayer = document.getElementById('wires-layer');
          const schematicGroup = wiresLayer && wiresLayer.querySelector('#schematic-group');
          if (schematicGroup) {
            schematicGroup.querySelectorAll('.wire').forEach(w => w.classList.remove('powered'));
            const schematicBulb = schematicGroup.querySelector('#schematic-bulb');
            if (schematicBulb) schematicBulb.classList.remove('bulb-glow');
          }
        } catch (e) { /* no-op */ }
      }

      function startElectrons(current) {
        // Stop and clear previous
        stopElectrons();
        if (!circuitPowered) return;

        const svg = document.getElementById('circuit-svg');
        const electronsLayer = document.getElementById('electrons-layer');
        const wiresLayer = document.getElementById('wires-layer');
        if (!svg || !electronsLayer || !wiresLayer) return;

        electronsLayer.innerHTML = '';
        electronAnimState.electrons = [];

        const baseSpeed = current ? Math.max(30, current * 80) : 60; // px/sec fallback

        const wireEls = Array.from(wiresLayer.querySelectorAll('line, path'));

        wireEls.forEach(el => {
          const tag = (el.tagName || '').toLowerCase();

          if (tag === 'path') {
            let length = 0;
            try { length = el.getTotalLength(); } catch (e) { length = 0; }
            if (length <= 0) return;

            const count = Math.min(6, Math.max(1, Math.round(length / 120)));
            for (let i = 0; i < count; i++) {
              const circ = createSVGCircle(3);
              electronsLayer.appendChild(circ);
              electronAnimState.electrons.push({
                node: circ,
                kind: 'path',
                path: el,
                length,
                pos: (i / count) * length + Math.random() * 6,
                speed: baseSpeed * (0.7 + Math.random() * 0.8)
              });
            }
          } else if (tag === 'line') {
            const x1 = parseFloat(el.getAttribute('x1')) || 0;
            const y1 = parseFloat(el.getAttribute('y1')) || 0;
            const x2 = parseFloat(el.getAttribute('x2')) || 0;
            const y2 = parseFloat(el.getAttribute('y2')) || 0;
            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.hypot(dx, dy);
            if (length <= 0) return;

            const count = Math.min(6, Math.max(1, Math.round(length / 120)));
            for (let i = 0; i < count; i++) {
              const circ = createSVGCircle(3);
              electronsLayer.appendChild(circ);
              electronAnimState.electrons.push({
                node: circ,
                kind: 'line',
                line: el,
                x1, y1, x2, y2, dx, dy, length,
                pos: (i / count) * length + Math.random() * 6,
                speed: baseSpeed * (0.7 + Math.random() * 0.8)
              });
            }
          }
        });

        // Add schematic visual classes when appropriate
        addPoweredClassesIfSchematic();

        electronAnimState.lastTime = 0;
        electronAnimState.running = true;

        function loop(ts) {
          if (!electronAnimState.lastTime) electronAnimState.lastTime = ts;
          const dt = (ts - electronAnimState.lastTime) / 1000;
          electronAnimState.lastTime = ts;

          if (!circuitPowered) { stopElectrons(); return; }

          electronAnimState.electrons.forEach(e => {
            e.pos += e.speed * dt;
            if (e.pos > e.length) e.pos = e.pos % e.length;

            try {
              if (e.kind === 'path') {
                const p = e.path.getPointAtLength(e.pos);
                const pt = svg.createSVGPoint(); pt.x = p.x; pt.y = p.y;
                const ctm = e.path.getCTM() || svg.getCTM();
                const transformed = pt.matrixTransform(ctm);
                e.node.setAttribute('cx', transformed.x);
                e.node.setAttribute('cy', transformed.y);
              } else if (e.kind === 'line') {
                const t = e.pos / e.length;
                const x = e.x1 + e.dx * t;
                const y = e.y1 + e.dy * t;
                const pt = svg.createSVGPoint(); pt.x = x; pt.y = y;
                const ctm = e.line.getCTM() || svg.getCTM();
                const transformed = pt.matrixTransform(ctm);
                e.node.setAttribute('cx', transformed.x);
                e.node.setAttribute('cy', transformed.y);
              }
            } catch (err) { /* ignore transient DOM/read errors */ }
          });

          electronAnimState.rafId = requestAnimationFrame(loop);
        }

        electronAnimState.rafId = requestAnimationFrame(loop);
      }

      function stopElectrons() {
        electronAnimState.running = false;
        if (electronAnimState.rafId) {
          cancelAnimationFrame(electronAnimState.rafId);
          electronAnimState.rafId = null;
        }

        try {
          electronAnimState.electrons.forEach(e => { if (e.node && e.node.parentNode) e.node.parentNode.removeChild(e.node); });
        } catch (e) { /* ignore */ }
        electronAnimState.electrons = [];
        electronAnimState.lastTime = 0;

        const electronsLayer = document.getElementById('electrons-layer');
        if (electronsLayer) electronsLayer.innerHTML = '';

        // Remove schematic classes
        removePoweredClassesIfSchematic();

        // Do not change circuitPowered here; caller controls state
      }

      // Expose functions on the local/global scope
      window.startElectrons = startElectrons;
      window.stopElectrons = stopElectrons;
      window.animateElectrons = function() { if (electronAnimState.running) electronAnimState.rafId = requestAnimationFrame(function(ts){ electronAnimState.lastTime = ts; electronAnimState.rafId = requestAnimationFrame(arguments.callee); }); };
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c17872467f9b48c',t:'MTc2OTAwNjAyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>